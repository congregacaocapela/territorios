<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle de Territórios</title>
    
    <!-- PWA: Link para o Manifest -->
    <link rel="manifest" href="manifest1.json">
    <!-- PWA: Cor do tema para a barra do navegador (Android) -->
    <meta name="theme-color" content="#1f2937">
    <!-- PWA: Ícone para iOS -->
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/4f46e5/ffffff?text=PT">

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Substituído XLSX por html2pdf para melhor formatação visual -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-body::-webkit-scrollbar { width: 8px; }
        .modal-body::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .modal-body::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .modal-body::-webkit-scrollbar-thumb:hover { background: #555; }
        .selection-badge {
            display: inline-flex; align-items: center; background-color: #e0e7ff;
            color: #3730a3; padding: 4px 8px; border-radius: 16px;
            font-size: 14px; font-weight: 500; margin: 2px;
        }
        .selection-badge button {
            margin-left: 6px; color: #4f46e5; background: none;
            border: none; cursor: pointer; font-weight: bold;
        }
        .mode-btn-active { background-color: #4f46e5; color: white; }
        .mode-btn-inactive { background-color: #e5e7eb; color: #374151; }
        input[type="date"]:before {
            content: attr(placeholder) !important; color: #9ca3af; margin-right: 0.5em;
        }
        input[type="date"]:focus:before, input[type="date"]:valid:before { content: ""; }
        .table-bordered th, .table-bordered td {
            border: 1px solid #000; padding: 4px 8px; text-align: center;
            vertical-align: middle; height: 30px;
        }
        .table-bordered thead th { background-color: #e5e7eb; font-weight: bold; }
        .s13-delete-btn { background: none; border: none; color: red; cursor: pointer; font-weight: bold; margin-left: 10px; }
        .name-cell { font-weight: 500; }
        .row-odd td { background-color: #ffffff; }
        .row-even td { background-color: #e5e7eb; }
        .table-bordered tbody tr td[rowspan="2"] { background-color: #e5e7eb; font-weight: bold; }

        /* Estilos específicos para mobile na tabela S-13 */
        @media (max-width: 640px) {
            .s13-table-mobile th, .s13-table-mobile td {
                padding: 2px 4px;
                font-size: 12px;
                height: 28px;
            }
            .s13-table-mobile .name-cell {
                font-size: 11px; /* Nomes ainda menores para caber */
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Barra de Navegação Superior -->
    <nav class="bg-gray-800 text-white p-4 shadow-md sticky top-0 z-40">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <button id="nav-button" class="bg-gray-700 hover:bg-gray-600 font-semibold py-2 px-4 rounded-lg transition-colors">
                    S-13
                </button>
                <a href="gestaodequadras.html" class="bg-gray-700 hover:bg-gray-600 font-semibold py-2 px-4 rounded-lg transition-colors">
                    Quadras e Casas
                </a>
            </div>
            <h1 id="nav-title" class="text-lg sm:text-xl font-bold">Painel Principal</h1>
            <div class="flex items-center gap-1 sm:gap-2">
                 <button id="open-link-settings-modal-btn" title="Configurar Links dos Territórios" class="p-2 text-white hover:text-gray-300 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
                </button>
                <button id="open-history-modal-btn" title="Histórico de Designações" class="p-2 text-white hover:text-gray-300 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                </button>
                <button id="open-settings-modal-btn" title="Configurações de Designação" class="p-2 text-white hover:text-gray-300 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V15a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
            </div>
        </div>
    </nav>

    <!-- Container da Aplicação Principal -->
    <div id="territory-manager-view" class="container mx-auto p-2 sm:p-4 md:p-8">
        <!-- Cabeçalho -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Painel de Controle de Territórios</h1>
            <p class="text-base sm:text-lg text-gray-600 mt-2">Gestão visual do progresso e geração de mensagens.</p>
        </header>

        <!-- Seção de Designação -->
        <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-md mb-8">
            <div class="flex border-b pb-4 mb-6 gap-2">
                <button id="mode-weekday" class="mode-btn-active flex-1 font-semibold py-2 px-4 rounded-lg transition-colors">Dias de Semana</button>
                <button id="mode-weekend" class="mode-btn-inactive flex-1 font-semibold py-2 px-4 rounded-lg transition-colors">Final de Semana</button>
            </div>

            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                <h2 class="text-xl sm:text-2xl font-semibold text-center sm:text-left">Designação da Programação</h2>
                <div class="flex items-center gap-2 w-full sm:w-auto">
                    <label for="week-picker" class="text-sm font-medium text-gray-700 whitespace-nowrap">Selecionar Data:</label>
                    <input type="date" id="week-picker" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
            <p id="week-dates" class="text-md text-gray-600 mb-6 text-center sm:text-left"></p>
            
            <div id="weekday-assignments-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 mb-6"></div>
            <div id="weekend-assignments-container" class="hidden grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-6"></div>

            <div class="text-center border-t pt-6 flex flex-col sm:flex-row justify-center gap-4">
                 <button id="clear-assignments-btn" class="w-full sm:w-auto bg-yellow-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-yellow-600 transition-colors">Limpar Designações</button>
                 <button id="generate-message-btn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">Gerar e Registrar Designações</button>
            </div>

            <div id="message-output-container" class="hidden mt-6">
                <label for="whatsapp-message" class="block mb-2 font-medium text-gray-700">Mensagem gerada:</label>
                <textarea id="whatsapp-message" rows="10" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50" readonly></textarea>
                <div class="flex flex-col sm:flex-row gap-2 mt-2">
                    <a id="send-whatsapp-link" href="#" target="_blank" class="flex-1 inline-flex items-center justify-center gap-2 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
                        <span>WhatsApp</span>
                    </a>
                    <button id="copy-message-btn" class="flex-1 inline-flex items-center justify-center gap-2 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM-1 8a.5.5 0 0 1 .5-.5h15a.5.5 0 0 1 0 1H-.5A.5.5 0 0 1-1 8z"/></svg>
                        <span>Copiar</span>
                    </button>
                </div>
                 <span id="copy-success" class="mt-2 text-green-600 font-medium hidden">Mensagem copiada com sucesso!</span>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4">
            <h2 id="grid-title" class="text-xl sm:text-2xl font-semibold">Territórios Ativos</h2>
            <button id="toggle-archived-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 text-sm sm:text-base">Mostrar Arquivados</button>
        </div>

        <div id="territory-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 sm:gap-6"></div>
        
        <div class="mt-8 text-center border-t pt-6 flex flex-col sm:flex-row justify-center gap-4">
            <button id="reset-archived-btn" class="w-full sm:w-auto bg-yellow-500 text-white font-semibold py-2 px-6 rounded-md hover:bg-yellow-600">Zerar/Restaurar Arquivados</button>
            <button id="reset-territories-btn" class="w-full sm:w-auto bg-red-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-red-700">Zerar Todos (Exceto Pessoais)</button>
        </div>
    </div>

    <!-- Container para a Aplicação S-13 -->
    <div id="s13-view" class="hidden container mx-auto p-2 sm:p-4 md:p-8">
        <header class="text-center mb-4">
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-700">Registro de Territórios S-13</h1>
        </header>
        <div class="text-center mb-8 flex flex-col sm:flex-row justify-center gap-4">
             <button id="open-add-record-modal-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Adicionar Registro</button>
             <button id="open-names-modal-btn" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-600">Gerenciar Nomes</button>
        </div>
        
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
             <div class="text-center py-2 flex justify-between items-center px-4">
                <h2 class="text-lg sm:text-xl font-bold">Ano de Serviço: 2025</h2>
                <div id="s13-pagination-controls" class="flex items-center gap-2"></div>
            </div>
            <div class="overflow-x-auto p-2 sm:p-4">
                <table id="s13-planilha" class="w-full table-bordered s13-table-mobile text-sm">
                    <thead>
                        <tr>
                            <th rowspan="2" class="w-16">Terr. n.º</th><th rowspan="2" class="w-24">Última data concluída</th>
                            <th colspan="2">Designado para</th><th colspan="2">Designado para</th>
                            <th colspan="2">Designado para</th><th colspan="2">Designado para</th>
                        </tr>
                        <tr>
                            <th>Data da desig.</th><th>Data da conclusão</th><th>Data da desig.</th><th>Data da conclusão</th>
                            <th>Data da desig.</th><th>Data da conclusão</th><th>Data da desig.</th><th>Data da conclusão</th>
                        </tr>
                    </thead>
                    <tbody id="s13-planilha-corpo"></tbody>
                </table>
            </div>
        </div>
        <div class="mt-8 text-center flex flex-col sm:flex-row justify-center gap-4">
            <button id="s13-baixar-pdf" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-green-700">Baixar S-13 (PDF)</button>
            <button id="s13-reset-btn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-red-700">Zerar Planilha</button>
        </div>
    </div>

    <!-- Modais -->
    <div id="status-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 id="status-modal-title" class="text-2xl font-bold"></h2>
                <button id="close-status-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div class="p-6 max-h-[60vh] overflow-y-auto modal-body">
                <!-- Seção de Designação Pessoal -->
                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200 mb-6">
                    <h4 class="text-lg font-semibold text-indigo-800 mb-3">Designação Pessoal</h4>
                    <label for="personal-assignment-select" class="block text-sm font-medium text-gray-700 mb-1">Designar para:</label>
                    <select id="personal-assignment-select" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white"></select>
                    <div class="flex gap-2 mt-3">
                        <button id="save-personal-btn" class="flex-1 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Salvar</button>
                        <button id="remove-personal-btn" class="flex-1 bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-400">Remover</button>
                    </div>
                </div>

                <!-- Seção de Quadras -->
                <div id="status-modal-blocks-container" class="space-y-3">
                    <!-- Conteúdo gerado por JS -->
                </div>
            </div>
            <div class="p-6 bg-gray-50 rounded-b-2xl text-right">
                <button id="save-status-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Fechar</button>
            </div>
        </div>
    </div>
    <div id="selection-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg"><div class="p-6 border-b flex justify-between items-center"><h2 id="selection-modal-title" class="text-2xl font-bold"></h2><button id="close-selection-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div><div id="selection-modal-body" class="p-6 max-h-[60vh] overflow-y-auto modal-body grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div><div class="p-6 bg-gray-50 rounded-b-2xl text-right"><button id="confirm-selection-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Confirmar</button></div></div>
    </div>
    <div id="s13-names-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex justify-center items-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md relative"><button id="s13-close-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button><h2 class="text-xl font-semibold mb-4 text-gray-800">Gerenciar Publicadores</h2><form id="s13-add-name-form" class="flex items-end gap-4 mb-4"><div class="flex-grow"><label for="s13-novo-nome-input" class="block text-sm font-medium text-gray-700 mb-1">Nome do Publicador</label><input type="text" id="s13-novo-nome-input" placeholder="Digite um novo nome" class="w-full px-3 py-2 border border-gray-300 rounded-md"></div><button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700">Cadastrar</button></form><h3 class="text-lg font-medium text-gray-700 mb-2">Nomes Cadastrados:</h3><div class="max-h-60 overflow-y-auto border p-2 rounded-md"><ul id="s13-lista-publicadores" class="list-disc list-inside space-y-1"></ul></div></div>
    </div>
    <div id="s13-add-record-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex justify-center items-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-5xl relative">
            <button id="s13-close-add-record-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Adicionar Novo Registro</h2>
            <form id="s13-registro-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                <div><label for="s13-territorio-numero" class="block text-sm font-medium text-gray-700 mb-1">Número do Território</label><input type="number" id="s13-territorio-numero" placeholder="1-46" min="1" max="46" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></div>
                <div><label for="s13-nome-select" class="block text-sm font-medium text-gray-700 mb-1">Designado para (Nome)</label><select id="s13-nome-select" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white"></select></div>
                <div><label for="s13-data-inicio" class="block text-sm font-medium text-gray-700 mb-1">Data da Designação</label><input type="date" id="s13-data-inicio" placeholder="Selecione a data" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></div>
                <div><label for="s13-data-conclusao" class="block text-sm font-medium text-gray-700 mb-1">Data da Conclusão</label><input type="date" id="s13-data-conclusao" placeholder="Selecione a data" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Adicionar à Planilha</button>
            </form>
        </div>
    </div>
    <div id="settings-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex justify-center items-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl relative">
            <button id="close-settings-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Configurações de Designação</h2>
            <form id="settings-form">
                <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-4 modal-body">
                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2">Dias de Semana</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="weekday-settings-container"></div>
                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mt-6">Final de Semana</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="weekend-settings-container"></div>
                    
                    <!-- INÍCIO: Seção de Gerenciamento de Territórios -->
                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mt-6">Gerenciar Territórios</h3>
                    <div class="p-4 bg-gray-50 rounded-lg border">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                            <div>
                                <label for="new-territory-id" class="block text-sm font-medium text-gray-700">Nº Território</label>
                                <input type="number" id="new-territory-id" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Ex: 47" min="1">
                            </div>
                            <div>
                                <label for="new-territory-blocks" class="block text-sm font-medium text-gray-700">Quadras</label>
                                <input type="text" id="new-territory-blocks" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Ex: A, B, C">
                            </div>
                            <button type="button" id="add-territory-btn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700">Adicionar</button>
                        </div>
                    </div>
                    <div id="territory-management-list-container" class="mt-4 space-y-2">
                        <!-- Lista de territórios será renderizada here pelo JS -->
                    </div>
                    <!-- FIM: Seção de Gerenciamento de Territórios -->

                </div>
                <div class="mt-6 pt-4 border-t flex justify-end gap-4">
                    <button type="button" id="cancel-settings-btn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-md hover:bg-gray-400">Fechar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-blue-700">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    <div id="history-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex justify-center items-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-3xl relative">
            <button id="close-history-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Histórico de Designações</h2>
            <div class="p-4 bg-gray-50 rounded-lg mb-4 border">
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="history-start-date" class="block text-sm font-medium text-gray-700">De:</label>
                        <input type="date" id="history-start-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="history-end-date" class="block text-sm font-medium text-gray-700">Até:</label>
                        <input type="date" id="history-end-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div class="flex gap-2">
                        <button id="filter-history-btn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700">Filtrar</button>
                        <button id="clear-history-filter-btn" class="w-full bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-400">Limpar</button>
                    </div>
                </div>
            </div>
            <div id="history-container" class="space-y-4 max-h-[50vh] overflow-y-auto pr-4 modal-body">
                <!-- Histórico é gerado via JS -->
            </div>
        </div>
    </div>
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex justify-center items-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
            <h2 id="confirmation-title" class="text-xl font-bold mb-4"></h2>
            <p id="confirmation-message" class="mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-action-btn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-red-700">Confirmar</button>
                <button id="cancel-action-btn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-md hover:bg-gray-400">Cancelar</button>
            </div>
        </div>
    </div>
     <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex justify-center items-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
            <h2 id="custom-alert-title" class="text-xl font-bold mb-4">Aviso</h2>
            <p id="custom-alert-message" class="mb-6"></p>
            <div class="flex justify-center">
                <button id="custom-alert-ok-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>
    <!-- Link Settings Modal -->
    <div id="link-settings-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex justify-center items-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl relative">
            <button id="close-link-settings-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Configurar Links dos Territórios</h2>
            <form id="link-settings-form">
                <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-4 modal-body grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4" id="link-settings-container">
                    <!-- Inputs serão gerados via JS -->
                </div>
                <div class="mt-6 pt-4 border-t flex justify-end gap-4">
                    <button type="button" id="cancel-link-settings-btn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-md hover:bg-gray-400">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-blue-700">Salvar Links</button>
                </div>
            </form>
        </div>
    </div>


    <!-- SCRIPT DE INICIALIZAÇÃO DO FIREBASE (MODULAR) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc, query, orderBy, limit, serverTimestamp, runTransaction, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDyK9M4Fg-iU9IVrNqWmuvDJExhnSnyrbI",
            authDomain: "territorios-3c460.firebaseapp.com",
            projectId: "territorios-3c460",
            storageBucket: "territorios-3c460.appspot.com",
            messagingSenderId: "604583240744",
            appId: "1:604583240744:web:69d70fb10596774045411d",
            measurementId: "G-WKYBRTJGQ6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.dispatchEvent(new CustomEvent('firebaseReady', { detail: { db, collection, doc, setDoc, onSnapshot, addDoc, query, orderBy, limit, serverTimestamp, runTransaction, updateDoc } }));
    </script>


    <!-- SCRIPT PRINCIPAL DA APLICAÇÃO -->
    <script>
    document.addEventListener('firebaseReady', ({ detail }) => {
        const { db, collection, doc, setDoc, onSnapshot, addDoc, query, orderBy, limit, serverTimestamp, runTransaction, updateDoc } = detail;

        // =================================================================
        // Custom Alert Function
        // =================================================================
        const customAlert = (message) => {
            const modal = document.getElementById('custom-alert-modal');
            const msgElem = document.getElementById('custom-alert-message');
            if(modal && msgElem) {
                msgElem.textContent = message;
                modal.classList.remove('hidden');
            } else {
                alert(message);
            }
        };
        const alertOkBtn = document.getElementById('custom-alert-ok-btn');
        if (alertOkBtn) {
            alertOkBtn.addEventListener('click', () => {
                const modal = document.getElementById('custom-alert-modal');
                if(modal) modal.classList.add('hidden');
            });
        }


        // =================================================================
        // PAINEL DE CONTROLE DE TERRITÓRIOS - LÓGICA
        // =================================================================
        const territoryManager = {
            defaultConfig: {
                weekday: { 'SEGUNDA': 'Silvino Amorim', 'TERÇA': 'Vitor ou Wagner', 'QUARTA': 'Getulio Rodrigues', 'QUINTA': 'Ivo Janson', 'SEXTA': 'Francisco Godoy' },
                weekend: { 'SABADO-1': 'GRUPOS 1, 2 e 3', 'SABADO-2': 'GRUPOS 4 e 5', 'SABADO-3': 'GRUPOS 6, 7 e 8', 'DOMINGO': 'Responsável do Domingo' },
                weekendGroupNames: { 'SABADO-1': 'Marcio Arruda', 'SABADO-2': 'Francisco Godoy', 'SABADO-3': 'Willian Lindem' },
                rural: ['Iteraçu', 'Barra', 'Barreirinho', 'Canguera', 'Plens', 'Guarapiranga', 'Iperozinho', 'Morro']
            },
            territoryLinks: {},
            state: { 
                config: {},
                status: {}, 
                weekdaySelections: {}, 
                weekendSelections: {}, 
                archived: [], 
                mode: 'weekday', 
                showArchived: false, 
                assignmentLog: {},
                personalAssignments: {}, // NOVO: Armazena designações pessoais { "1": "Marcia" }
                selectedDate: new Date(),
                history: []
            },
            ui: {
                grid: document.getElementById('territory-grid'), statusModal: document.getElementById('status-modal'), selectionModal: document.getElementById('selection-modal'),
                weekdayContainer: document.getElementById('weekday-assignments-container'), weekendContainer: document.getElementById('weekend-assignments-container'),
                modeWeekdayBtn: document.getElementById('mode-weekday'), modeWeekendBtn: document.getElementById('mode-weekend'),
                generateMessageBtn: document.getElementById('generate-message-btn'), messageOutputContainer: document.getElementById('message-output-container'),
                whatsappMessage: document.getElementById('whatsapp-message'), sendWhatsappLink: document.getElementById('send-whatsapp-link'), copyMessageBtn: document.getElementById('copy-message-btn'),
                copySuccess: document.getElementById('copy-success'), toggleArchivedBtn: document.getElementById('toggle-archived-btn'),
                gridTitle: document.getElementById('grid-title'), weekDates: document.getElementById('week-dates'),
                weekPicker: document.getElementById('week-picker'),
                resetTerritoriesBtn: document.getElementById('reset-territories-btn'),
                resetArchivedBtn: document.getElementById('reset-archived-btn'),
                clearAssignmentsBtn: document.getElementById('clear-assignments-btn'),
                settingsModal: document.getElementById('settings-modal'),
                openSettingsBtn: document.getElementById('open-settings-modal-btn'),
                closeSettingsBtn: document.getElementById('close-settings-modal-btn'),
                cancelSettingsBtn: document.getElementById('cancel-settings-btn'),
                settingsForm: document.getElementById('settings-form'),
                weekdaySettingsContainer: document.getElementById('weekday-settings-container'),
                weekendSettingsContainer: document.getElementById('weekend-settings-container'),
                historyModal: document.getElementById('history-modal'),
                openHistoryBtn: document.getElementById('open-history-modal-btn'),
                closeHistoryBtn: document.getElementById('close-history-modal-btn'),
                historyContainer: document.getElementById('history-container'),
                historyStartDate: document.getElementById('history-start-date'),
                historyEndDate: document.getElementById('history-end-date'),
                filterHistoryBtn: document.getElementById('filter-history-btn'),
                clearHistoryFilterBtn: document.getElementById('clear-history-filter-btn'),
                linkSettingsModal: document.getElementById('link-settings-modal'),
                openLinkSettingsBtn: document.getElementById('open-link-settings-modal-btn'),
                closeLinkSettingsBtn: document.getElementById('close-link-settings-modal-btn'),
                cancelLinkSettingsBtn: document.getElementById('cancel-link-settings-btn'),
                linkSettingsForm: document.getElementById('link-settings-form'),
                linkSettingsContainer: document.getElementById('link-settings-container'),
            },
            data: [], // Os dados dos territórios agora são carregados do Firestore

            initialize() {
                this.listenForRealtimeUpdates();
                this.setupEventListeners();
                this.setupWeekPicker();
            },

            listenForRealtimeUpdates() {
                // Listener para a lista de territórios
                onSnapshot(doc(db, "appState", "territoryList"), (docSnapshot) => {
                    const defaultTerritories = [
                        {id: 1, blocks: ['A', 'B', 'C', 'D']}, {id: 2, blocks: ['A', 'B', 'C', 'D']}, {id: 3, blocks: ['A', 'B']}, {id: 4, blocks: ['A', 'B', 'C']}, {id: 5, blocks: ['A', 'B', 'C']},
                        {id: 6, blocks: ['A', 'B', 'C']}, {id: 7, blocks: ['A', 'B', 'C', 'D']}, {id: 8, blocks: ['A', 'B', 'C', 'D']}, {id: 9, blocks: ['A', 'B', 'C']}, {id: 10, blocks: ['A', 'B', 'C']},
                        {id: 11, blocks: ['A', 'B']}, {id: 12, blocks: ['A', 'B', 'C', 'D']}, {id: 13, blocks: ['A', 'B', 'C', 'D', 'E', 'F']}, {id: 14, blocks: ['A']}, {id: 15, blocks: ['A', 'B', 'C', 'D', 'E']},
                        {id: 16, blocks: ['A', 'B', 'C', 'D', 'E']}, {id: 17, blocks: ['A', 'B', 'C', 'D', 'E', 'F']}, {id: 18, blocks: ['A', 'B', 'C', 'D', 'E', 'F']}, {id: 19, blocks: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I']},
                        {id: 20, blocks: ['A', 'B', 'C']}, {id: 21, blocks: ['A', 'B', 'C', 'D', 'E']}, {id: 22, blocks: ['A', 'B', 'C', 'D', 'E']}, {id: 23, blocks: ['A', 'B', 'C']}, {id: 24, blocks: ['A', 'B', 'C', 'D', 'E', 'F', 'G']},
                        {id: 25, blocks: ['A', 'B', 'C']}, {id: 26, blocks: ['A', 'B', 'C', 'D']}, {id: 27, blocks: ['A', 'B', 'C', 'D']}, {id: 28, blocks: ['A', 'B', 'C', 'D', 'E', 'F']}, {id: 29, blocks: ['A', 'B', 'C', 'D', 'E', 'F', 'G']},
                        {id: 30, blocks: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J']}, {id: 31, blocks: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H']}, {id: 32, blocks: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K']},
                        {id: 33, blocks: ['A', 'B', 'C', 'D', 'E']}, {id: 34, blocks: ['A', 'B', 'C', 'D', 'E', 'F', 'G']}, {id: 35, blocks: ['A', 'B', 'C', 'D', 'E', 'F', 'G']}, {id: 36, blocks: ['A', 'B', 'C']},
                        {id: 37, blocks: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K']}, {id: 38, blocks: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H']}, {id: 39, blocks: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'L', 'M']},
                        {id: 40, blocks: ['A', 'B']}, {id: 41, blocks: ['A', 'B', 'C', 'D', 'E']}, {id: 42, blocks: ['A', 'B', 'C', 'D', 'E', 'F']}, {id: 43, blocks: ['A', 'B', 'C', 'D']}, {id: 44, blocks: ['A', 'B', 'C']},
                        {id: 45, blocks: ['A', 'B', 'C', 'D']}, {id: 46, blocks: ['A']}
                    ];
                    if (docSnapshot.exists() && docSnapshot.data().territories) {
                        this.data = docSnapshot.data().territories;
                    } else {
                        console.log("Nenhuma lista de territórios encontrada, criando uma nova com dados padrão.");
                        this.data = defaultTerritories;
                        setDoc(doc(db, "appState", "territoryList"), { territories: defaultTerritories });
                    }
                    
                    // Sincroniza o status (na memória) com a nova lista de territórios
                    this.data.forEach(t => {
                        if (!this.state.status[t.id]) {
                            // Se o território não tem *nenhuma* entrada de status, cria uma
                            this.state.status[t.id] = {};
                            console.log(`Inicializando status para território ${t.id}`);
                        }
                        // Garante que *todas* as quadras (blocks) de 'this.data' tenham um valor (true/false)
                        t.blocks.forEach(b => {
                            if (this.state.status[t.id][b] === undefined) {
                                this.state.status[t.id][b] = false; // Define como 'false' (pendente) se for indefinido
                            }
                        });
                    });

                    // Sincroniza com o app S-13
                    const maxTerritoryId = this.data.length > 0 ? Math.max(...this.data.map(t => t.id)) : 0;
                    s13App.config.numTerritories = maxTerritoryId;
                    if (s13App.ui.territorioNumeroInput) {
                        s13App.ui.territorioNumeroInput.max = maxTerritoryId;
                        s13App.ui.territorioNumeroInput.placeholder = `1-${maxTerritoryId}`;
                    }

                    // Re-renderiza componentes que dependem dos dados dos territórios
                    this.renderAll();
                    if (s13App.state.s13Data) s13App.renderTable(s13App.state.currentPage);
                    if (!this.ui.settingsModal.classList.contains('hidden')) this.renderTerritoryManagement();
                    if (!this.ui.linkSettingsModal.classList.contains('hidden')) this.openLinkSettingsModal();
                });

                onSnapshot(doc(db, "appState", "mainState"), (docSnapshot) => {
                    console.log("Recebida atualização do 'mainState'");
                    const mainState = docSnapshot.exists() ? docSnapshot.data() : {};
                    this.state.status = mainState.status || {};
                    this.state.weekdaySelections = mainState.weekdaySelections || {};
                    this.state.weekendSelections = mainState.weekendSelections || {};
                    this.state.archived = mainState.archived || [];
                    this.state.assignmentLog = mainState.assignmentLog || {};
                    this.state.personalAssignments = mainState.personalAssignments || {}; // NOVO: Carrega designações pessoais
                    this.state.mode = mainState.mode || 'weekday';

                    // Sincroniza o status com a lista de territórios atual
                    this.data.forEach(t => {
                        if (!this.state.status[t.id]) {
                            // Se o território não tem *nenhuma* entrada de status, cria uma
                            this.state.status[t.id] = {};
                            console.log(`Inicializando status para território ${t.id}`);
                        }
                        // Garante que *todas* as quadras (blocks) de 'this.data' tenham um valor (true/false)
                        t.blocks.forEach(b => {
                            if (this.state.status[t.id][b] === undefined) {
                                this.state.status[t.id][b] = false; // Define como 'false' (pendente) se for indefinido
                            }
                        });
                    });

                    this.renderAll();
                });

                onSnapshot(doc(db, "appState", "assignmentsConfig"), (docSnapshot) => {
                    console.log("Recebida atualização da 'assignmentsConfig'");
                    const configData = docSnapshot.exists() ? docSnapshot.data() : {};
                    this.state.config = {
                        ...this.defaultConfig, ...configData,
                        weekday: { ...this.defaultConfig.weekday, ...(configData.weekday || {}) },
                        weekend: { ...this.defaultConfig.weekend, ...(configData.weekend || {}) },
                        weekendGroupNames: { ...this.defaultConfig.weekendGroupNames, ...(configData.weekendGroupNames || {}) }
                    };
                    this.renderAssignmentCards();
                });

                const historyQuery = query(collection(db, "assignmentHistory"), orderBy("timestamp", "desc"), limit(100));
                onSnapshot(historyQuery, (querySnapshot) => {
                    console.log("Recebida atualização do 'assignmentHistory'");
                    this.state.history = [];
                    querySnapshot.forEach((doc) => {
                        this.state.history.push({ id: doc.id, ...doc.data() });
                    });
                    this.filterAndRenderHistory();
                });

                onSnapshot(doc(db, "appState", "territoryLinks"), (docSnapshot) => {
                    console.log("Recebida atualização dos 'territoryLinks'");
                    this.territoryLinks = docSnapshot.exists() ? docSnapshot.data().links || {} : {};
                });
            },

            async saveState() {
                try {
                    const mainStateData = {
                        status: this.state.status,
                        weekdaySelections: this.state.weekdaySelections,
                        weekendSelections: this.state.weekendSelections,
                        archived: this.state.archived,
                        assignmentLog: this.state.assignmentLog,
                        personalAssignments: this.state.personalAssignments, // NOVO: Salva designações pessoais
                        mode: this.state.mode
                    };
                    await setDoc(doc(db, "appState", "mainState"), mainStateData, { merge: true });
                    console.log("Estado principal salvo no Firestore!");
                } catch (error) {
                    console.error("Erro ao salvar o estado principal:", error);
                }
            },
            
            renderAll() { 
                this.updateDateDisplay(); 
                this.renderGrid(); 
                this.renderAssignmentCards(); 
                this.setMode(this.state.mode, false);
            },
            renderGrid() {
                if (!this.ui.grid) return;
                this.ui.grid.innerHTML = '';
                if (!this.data) return;
                const territoriesToDisplay = this.data.filter(t => this.state.showArchived ? this.state.archived.includes(t.id) : !this.state.archived.includes(t.id));
                if (territoriesToDisplay.length === 0) { this.ui.grid.innerHTML = `<p class="col-span-full text-center text-gray-500">${this.state.showArchived ? 'Nenhum território arquivado.' : 'Nenhum território ativo.'}</p>`; }
                else { territoriesToDisplay.forEach(t => this.ui.grid.appendChild(this.createTerritoryCard(t))); }
            },
            createTerritoryCard(t) {
                const card = document.createElement('div');
                const isArchived = this.state.archived.includes(t.id);
                card.className = `territory-card bg-white p-5 rounded-2xl shadow-md flex flex-col transition-all duration-300 ${isArchived ? 'opacity-70' : 'hover:shadow-xl hover:-translate-y-1'}`;
                card.dataset.territoryId = t.id;
                
                const p = this.getTerritoryProgress(t.id);
                const personalName = this.state.personalAssignments[t.id];
                
                let personalBadge = '';
                if (personalName) {
                    personalBadge = `
                    <div class="flex items-center gap-1 mt-2 text-xs font-semibold text-indigo-700 bg-indigo-100 px-2 py-1 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        <span>${personalName}</span>
                    </div>`;
                }

                let actionButton = '';
                if (isArchived) { actionButton = `<button class="restore-btn mt-4 w-full bg-green-100 text-green-700 font-semibold py-2 px-4 rounded-lg hover:bg-green-200" data-id="${t.id}">Restaurar</button>`; }
                else if (p.progress === 100) { actionButton = `<button class="archive-btn mt-4 w-full bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200" data-id="${t.id}">Arquivar</button>`; }
                
                card.innerHTML = `
                    <div class="flex-grow cursor-pointer" data-action="open-status">
                        <div class="flex justify-between items-start">
                            <h3 class="text-xl font-bold text-gray-900">Território ${t.id}</h3>
                            <span class="status-badge text-xs font-semibold ${p.textColorClass} ${p.bgColorClass} px-2 py-1 rounded-full">${p.statusText}</span>
                        </div>
                        ${personalBadge} <!-- Badge pessoal inserido aqui -->
                        <p class="text-sm text-gray-500 mt-3">${p.completedCount} de ${p.totalCount} quadras</p>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                            <div class="${p.statusColorClass} h-2.5 rounded-full" style="width: ${p.progress}%"></div>
                        </div>
                    </div>
                    ${actionButton}`;
                return card;
            },
            getTerritoryProgress(id) {
                const status = this.state.status[id] || {}; 
                const territory = this.data.find(t => t.id === id);
                const totalCount = territory ? territory.blocks.length : 0;
                const completedCount = Object.values(status).filter(Boolean).length;
                const progress = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;
                let s = { text: 'Pendente', color: 'bg-red-500', textC: 'text-red-800', bgC: 'bg-red-100' };
                if (progress === 100) { s = { text: 'Concluído', color: 'bg-green-500', textC: 'text-green-800', bgC: 'bg-green-100' }; }
                else if (progress > 0) { s = { text: 'Em Andamento', color: 'bg-yellow-500', textC: 'text-yellow-800', bgC: 'bg-yellow-100' }; }
                return { completedCount, totalCount, progress, statusText: s.text, statusColorClass: s.color, textColorClass: s.textC, bgColorClass: s.bgC };
            },
            renderAssignmentCards() {
                if (!this.ui.weekdayContainer || !this.ui.weekendContainer) return;
                this.ui.weekdayContainer.innerHTML = '';
                const dayOffsets = { 'SEGUNDA': 0, 'TERÇA': 1, 'QUARTA': 2, 'QUINTA': 3, 'SEXTA': 4 };
                const startDate = this.getAssignmentStartDate();
                
                for (const [day, person] of Object.entries(this.state.config.weekday || {})) {
                    const assignmentDate = new Date(startDate.getTime());
                    assignmentDate.setUTCDate(startDate.getUTCDate() + (dayOffsets[day] || 0));
                    this.ui.weekdayContainer.appendChild(this.createAssignmentCard(day, person, this.state.weekdaySelections[day] || [], assignmentDate));
                }
                
                this.ui.weekendContainer.innerHTML = '';
                const weekendStartDate = this.getAssignmentStartDate();
                const saturdayDate = new Date(weekendStartDate.getTime());
                saturdayDate.setUTCDate(weekendStartDate.getUTCDate() + 5);
                const sundayDate = new Date(weekendStartDate.getTime());
                sundayDate.setUTCDate(weekendStartDate.getUTCDate() + 6);

                for (const [key, name] of Object.entries(this.state.config.weekend || {})) {
                    if (key === 'DOMINGO') {
                        this.ui.weekendContainer.appendChild(this.createSundayCard(sundayDate));
                    } else {
                        this.ui.weekendContainer.appendChild(this.createAssignmentCard(key, name, this.state.weekendSelections[key] || [], saturdayDate));
                    }
                }
            },
            createAssignmentCard(key, title, selections, date) {
                const card = document.createElement('div');
                card.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200 flex flex-col';
                const format = (d) => {
                    const day = String(d.getUTCDate()).padStart(2, '0');
                    const month = String(d.getUTCMonth() + 1).padStart(2, '0');
                    return `${day}/${month}`;
                };
                const dateString = date ? `<span class="font-normal text-gray-500 text-sm">${format(date)}</span>` : '';

                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-baseline">
                            <h3 class="font-bold text-lg text-gray-800">${key.startsWith('SABADO') ? 'SÁBADO' : key}</h3>
                            ${dateString}
                        </div>
                        <p class="text-sm text-gray-600 mb-3">${title}</p>
                    </div>
                    <div class="flex-grow min-h-[60px] bg-white border rounded-md p-1 flex flex-wrap gap-1" id="badges-${key}"></div>
                    <button class="add-territory-btn mt-3 w-full bg-indigo-100 text-indigo-700 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-200" data-key="${key}">Adicionar</button>`;
                
                const badgeContainer = card.querySelector(`#badges-${key}`);
                if (selections.length === 0) {
                    badgeContainer.innerHTML = `<span class="text-xs text-gray-400 p-2">Nenhum</span>`;
                } else {
                    selections.forEach(id => {
                        badgeContainer.innerHTML += `<span class="selection-badge">T-${id} <button data-key="${key}" data-id="${id}">&times;</button></span>`;
                    });
                }
                return card;
            },
            createSundayCard(date) {
                const key = 'DOMINGO';
                const card = document.createElement('div');
                card.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200 flex flex-col';
                const publicadores = s13App.state.publicadores || [];
                let optionsHTML = '<option value="">Selecione um responsável</option>';
                const sundaySelection = this.state.weekendSelections.DOMINGO || { name: '', territories: [] };
                publicadores.forEach(nome => {
                    const isSelected = sundaySelection.name === nome ? 'selected' : '';
                    optionsHTML += `<option value="${nome}" ${isSelected}>${nome}</option>`;
                });

                const format = (d) => {
                    const day = String(d.getUTCDate()).padStart(2, '0');
                    const month = String(d.getUTCMonth() + 1).padStart(2, '0');
                    return `${day}/${month}`;
                };
                const dateString = date ? `<span class="font-normal text-gray-500 text-sm">${format(date)}</span>` : '';

                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-baseline">
                            <h3 class="font-bold text-lg text-gray-800">DOMINGO</h3>
                            ${dateString}
                        </div>
                        <select id="sunday-name-select" class="w-full p-2 border border-gray-300 rounded-md mt-1 mb-3 bg-white">${optionsHTML}</select>
                    </div>
                    <div class="flex-grow min-h-[60px] bg-white border rounded-md p-1 flex flex-wrap gap-1" id="badges-${key}"></div>
                    <button class="add-territory-btn mt-3 w-full bg-indigo-100 text-indigo-700 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-200" data-key="${key}">Adicionar</button>`;
                
                const badgeContainer = card.querySelector(`#badges-${key}`);
                const selections = sundaySelection.territories;
                if (selections.length === 0) {
                    badgeContainer.innerHTML = `<span class="text-xs text-gray-400 p-2">Nenhum</span>`;
                } else {
                    selections.forEach(id => {
                        badgeContainer.innerHTML += `<span class="selection-badge">${typeof id === 'number' ? 'T-' : ''}${id} <button data-key="${key}" data-id="${id}">&times;</button></span>`;
                    });
                }
                return card;
            },
            getAssignmentStartDate(baseDate = this.state.selectedDate) {
                const date = new Date(baseDate.getTime()); // Create a copy
                const dayOfWeek = date.getUTCDay(); // 0 (Sun) to 6 (Sat)
                
                if (this.state.mode === 'weekday') {
                    const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                    date.setUTCDate(date.getUTCDate() + diffToMonday);
                } else { // weekend
                    const diffToSaturday = 6 - dayOfWeek;
                    date.setUTCDate(date.getUTCDate() + diffToSaturday);
                }
                return date;
            },
            updateDateDisplay() {
                const format = (d) => {
                    const day = String(d.getUTCDate()).padStart(2, '0');
                    const month = String(d.getUTCMonth() + 1).padStart(2, '0');
                    return `${day}/${month}`;
                };
                const startDate = this.getAssignmentStartDate();
                if (this.state.mode === 'weekday' && this.ui.weekDates) {
                    const endDate = new Date(startDate.getTime());
                    endDate.setUTCDate(startDate.getUTCDate() + 4);
                    this.ui.weekDates.textContent = `Programação para a semana de ${format(startDate)} a ${format(endDate)}`;
                } else if (this.ui.weekDates) {
                    const endDate = new Date(startDate.getTime());
                    endDate.setUTCDate(startDate.getUTCDate() + 1);
                    this.ui.weekDates.textContent = `Programação para o final de semana de ${format(startDate)} e ${format(endDate)}`;
                }
            },
            setMode(mode, doSave = true) {
                this.state.mode = mode; const isWeekday = mode === 'weekday';
                if(this.ui.modeWeekdayBtn) {
                    this.ui.modeWeekdayBtn.classList.toggle('mode-btn-active', isWeekday); this.ui.modeWeekdayBtn.classList.toggle('mode-btn-inactive', !isWeekday);
                }
                if(this.ui.modeWeekendBtn) {
                    this.ui.modeWeekendBtn.classList.toggle('mode-btn-active', !isWeekday); this.ui.modeWeekendBtn.classList.toggle('mode-btn-inactive', isWeekday);
                }
                if(this.ui.weekdayContainer) this.ui.weekdayContainer.classList.toggle('hidden', !isWeekday);
                if(this.ui.weekendContainer) this.ui.weekendContainer.classList.toggle('hidden', isWeekday);
                this.updateDateDisplay(); 
                this.renderAssignmentCards(); // Re-render cards to show correct dates
                if (doSave) this.saveState();
            },
            openStatusModal(id) {
                const t = this.data.find(td => td.id === id); const modal = this.ui.statusModal;
                if (!t) { customAlert("Território não encontrado."); return; }
                const title = modal.querySelector('#status-modal-title');
                if(title) title.textContent = `Território ${t.id}`; 
                modal.dataset.currentTerritoryId = id;
                
                // NOVO: Lógica para Designação Pessoal
                const select = modal.querySelector('#personal-assignment-select');
                if (select) {
                    select.innerHTML = '<option value="">Ninguém (Padrão)</option>';
                    s13App.state.publicadores.forEach(name => {
                        select.innerHTML += `<option value="${name}">${name}</option>`;
                    });
                    select.value = this.state.personalAssignments[id] || "";
                }
                
                // Lógica antiga das Quadras
                const container = modal.querySelector('#status-modal-blocks-container');
                if(container) {
                    container.innerHTML = `<div class="flex items-center justify-between bg-gray-200 p-3 rounded-lg border-b-2 border-gray-300 mb-3"><label for="select-all-blocks" class="font-bold text-gray-700">Marcar Todas as Quadras</label><input type="checkbox" id="select-all-blocks" class="h-6 w-6 rounded text-blue-600"></div>`;
                    const wrapper = document.createElement('div'); wrapper.className = 'space-y-3'; let allChecked = true;
                    t.blocks.forEach(block => {
                        const isChecked = this.state.status[id] && this.state.status[id][block]; if (!isChecked) allChecked = false;
                        wrapper.innerHTML += `<div class="flex items-center justify-between bg-gray-100 p-3 rounded-lg"><label for="block-${block}" class="font-medium">Quadra ${block}</label><input type="checkbox" id="block-${block}" ${isChecked ? 'checked' : ''} class="h-6 w-6 block-checkbox" data-block="${block}"></div>`;
                    });
                    container.appendChild(wrapper); 
                    const selectAll = container.querySelector('#select-all-blocks');
                    if(selectAll) selectAll.checked = allChecked;
                }
                modal.classList.remove('hidden');
            },
            openSelectionModal(key) {
                const modal = this.ui.selectionModal; modal.dataset.currentKey = key;
                const title = modal.querySelector('#selection-modal-title');
                if(title) title.textContent = `Selecionar para ${key}`;
                const container = modal.querySelector('#selection-modal-body'); 
                if(!container) return;
                container.innerHTML = '';
                
                const allSelections = Object.values(this.state.weekdaySelections).flat().concat(Object.values(this.state.weekendSelections).map(v => Array.isArray(v) ? v : (v.territories || [])).flat());
                
                let currentSelections = [];
                if (this.state.mode === 'weekday') currentSelections = this.state.weekdaySelections[key] || [];
                else currentSelections = key === 'DOMINGO' ? (this.state.weekendSelections[key] || {territories:[]}).territories : (this.state.weekendSelections[key] || []);
                
                const available = this.data.filter(t => !this.state.archived.includes(t.id));
                available.forEach(t => {
                    const isSelectedElsewhere = allSelections.includes(t.id) && !currentSelections.includes(t.id);
                    const personalName = this.state.personalAssignments[t.id];
                    const isPersonal = !!personalName;
                    
                    const isDisabled = isSelectedElsewhere || isPersonal;
                    const isSelectedHere = currentSelections.includes(t.id);
                    
                    let personalText = '';
                    if(isPersonal) personalText = `<span class="text-xs text-indigo-600 block truncate">(Pessoal: ${personalName})</span>`;
                    
                    const labelClass = isDisabled 
                        ? 'bg-gray-200 cursor-not-allowed text-gray-400' 
                        : 'bg-gray-100 hover:bg-gray-200 cursor-pointer';

                    container.innerHTML += `
                        <label class="flex items-center p-3 rounded-lg ${labelClass}">
                            <input type="checkbox" value="${t.id}" ${isSelectedHere ? 'checked' : ''} ${isDisabled ? 'disabled' : ''} class="h-5 w-5">
                            <span class="ml-3 font-medium">
                                Território ${t.id}
                                ${personalText}
                            </span>
                        </label>`;
                });

                if (key === 'DOMINGO') {
                    container.innerHTML += `<h3 class="col-span-full font-bold text-lg mt-4 border-t pt-4">Territórios Rurais</h3>`;
                    this.state.config.rural.forEach(r => {
                        const isSelectedElsewhere = allSelections.includes(r) && !currentSelections.includes(r);
                        const isSelectedHere = currentSelections.includes(r);
                        container.innerHTML += `<label class="flex items-center p-3 rounded-lg ${isSelectedElsewhere ? 'bg-gray-200 cursor-not-allowed text-gray-400' : 'bg-gray-100 hover:bg-gray-200 cursor-pointer'}"><input type="checkbox" value="${r}" ${isSelectedHere ? 'checked' : ''} ${isSelectedElsewhere ? 'disabled' : ''} class="h-5 w-5"><span class="ml-3 font-medium">${r}</span></label>`;
                    });
                }
                modal.classList.remove('hidden');
            },
            openSettingsModal() {
                if(this.ui.weekdaySettingsContainer) this.ui.weekdaySettingsContainer.innerHTML = '';
                if(this.ui.weekendSettingsContainer) this.ui.weekendSettingsContainer.innerHTML = '';
                
                if(this.ui.weekdaySettingsContainer) {
                    for (const [key, value] of Object.entries(this.state.config.weekday)) {
                        this.ui.weekdaySettingsContainer.innerHTML += `<div><label for="setting-${key}" class="block text-sm font-medium text-gray-700">${key}</label><input type="text" id="setting-${key}" data-key="${key}" data-type="weekday" value="${value}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></div>`;
                    }
                }
                if(this.ui.weekendSettingsContainer) {
                    for (const [key, value] of Object.entries(this.state.config.weekend)) {
                        if (key !== 'DOMINGO') {
                            const groupNameValue = this.state.config.weekendGroupNames && this.state.config.weekendGroupNames[key] ? this.state.config.weekendGroupNames[key] : '';
                            this.ui.weekendSettingsContainer.innerHTML += `
                                <div class="border p-3 rounded bg-gray-50 mb-2">
                                    <label for="setting-${key}" class="block text-sm font-bold text-gray-800 mb-1">${key.replace('-', ' ')}</label>
                                    <div class="space-y-2">
                                        <div>
                                            <label class="block text-xs text-gray-500">Nome de Exibição (Painel):</label>
                                            <input type="text" id="setting-${key}" data-key="${key}" data-type="weekend" value="${value}" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-500">Nome para Registro S-13:</label>
                                            <input type="text" id="setting-groupname-${key}" data-key="${key}" data-type="weekendGroupNames" value="${groupNameValue}" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Marcio Arruda">
                                        </div>
                                    </div>
                                </div>`;
                        }
                    }
                }
                this.renderTerritoryManagement();
                if(this.ui.settingsModal) this.ui.settingsModal.classList.remove('hidden');
            },
            async saveSettings(e) {
                e.preventDefault();
                const newConfig = { 
                    weekday: {}, 
                    // Preserva as configurações existentes do fim de semana que não são editáveis neste modal (ex: DOMINGO)
                    weekend: { ...(this.state.config.weekend || {}) },
                    weekendGroupNames: { ...(this.state.config.weekendGroupNames || {}) }
                };

                // Seleciona apenas os inputs que pertencem à configuração de designação
                const inputs = this.ui.settingsForm ? this.ui.settingsForm.querySelectorAll('input[type="text"][data-type]') : [];
                
                inputs.forEach(input => {
                    const { key, type } = input.dataset;
                    if (newConfig[type]) { // Garante que o tipo ('weekday' ou 'weekend' ou 'weekendGroupNames') existe no objeto
                        newConfig[type][key] = input.value;
                    }
                });

                try {
                    await setDoc(doc(db, "appState", "assignmentsConfig"), newConfig, { merge: true });
                    console.log("Configurações salvas com sucesso!");
                    if(this.ui.settingsModal) this.ui.settingsModal.classList.add('hidden');
                } catch (error) {
                    console.error("Erro ao salvar configurações:", error);
                    customAlert("Falha ao salvar as configurações.");
                }
            },
            renderTerritoryManagement() {
                const container = document.getElementById('territory-management-list-container');
                if (!container) return;
                container.innerHTML = '';
                this.data.forEach(t => {
                    const territoryEl = document.createElement('div');
                    territoryEl.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-md';
                    territoryEl.innerHTML = `
                        <span><strong>Território ${t.id}</strong> - Quadras: ${t.blocks.join(', ')}</span>
                        <button type="button" class="delete-territory-btn text-red-500 hover:text-red-700 font-bold p-1 leading-none text-xl" data-id="${t.id}" title="Remover Território ${t.id}">&times;</button>
                    `;
                    container.appendChild(territoryEl);
                });
            },
            async saveTerritories() {
                try {
                    await setDoc(doc(db, "appState", "territoryList"), { territories: this.data });
                    console.log("Lista de territórios salva com sucesso!");
                } catch (error) {
                    console.error("Erro ao salvar territórios:", error);
                    customAlert("Falha ao salvar a lista de territórios.");
                }
            },
            openHistoryModal() {
                this.filterAndRenderHistory();
                if(this.ui.historyModal) this.ui.historyModal.classList.remove('hidden');
            },
            filterAndRenderHistory() {
                const startDate = (this.ui.historyStartDate && this.ui.historyStartDate.value) ? new Date(this.ui.historyStartDate.value + 'T00:00:00') : null;
                const endDate = (this.ui.historyEndDate && this.ui.historyEndDate.value) ? new Date(this.ui.historyEndDate.value + 'T23:59:59') : null;

                const filteredHistory = this.state.history.filter(entry => {
                    const entryDate = entry.timestamp?.toDate();
                    if (!entryDate) return false;
                    if (startDate && entryDate < startDate) return false;
                    if (endDate && entryDate > endDate) return false;
                    return true;
                });
                this.renderHistory(filteredHistory);
            },
            renderHistory(entries = this.state.history) {
                if (!this.ui.historyContainer) return;
                this.ui.historyContainer.innerHTML = '';
                if (entries.length === 0) {
                    this.ui.historyContainer.innerHTML = '<p class="text-gray-500 text-center">Nenhum histórico de designação encontrado para o período selecionado.</p>';
                    return;
                }
                entries.forEach((entry, index) => {
                    const timestamp = entry.timestamp?.toDate();
                    const formattedDate = timestamp ? new Intl.DateTimeFormat('pt-BR', { dateStyle: 'full', timeStyle: 'medium' }).format(timestamp) : 'Data indisponível';
                    const historyElement = document.createElement('div');
                    historyElement.className = 'p-4 border rounded-lg bg-gray-50';
                    const messageId = `history-message-${index}`;
                    historyElement.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-800">${entry.periodText}</p>
                                <p class="text-sm text-gray-500">${formattedDate}</p>
                            </div>
                            <button data-target="${messageId}" class="toggle-history-message bg-indigo-100 text-indigo-700 text-sm font-semibold py-1 px-3 rounded-lg hover:bg-indigo-200">Ver Mensagem</button>
                        </div>
                        <pre id="${messageId}" class="hidden mt-2 whitespace-pre-wrap text-sm bg-white p-2 rounded border text-gray-700">${entry.message}</pre>
                    `;
                    this.ui.historyContainer.appendChild(historyElement);
                });
            },
            openLinkSettingsModal() {
                const container = this.ui.linkSettingsContainer;
                if(!container) return;
                container.innerHTML = '';
                this.data.forEach(t => {
                    const link = this.territoryLinks[t.id] || '';
                    const inputGroup = `
                        <div>
                            <label for="link-t${t.id}" class="block text-sm font-medium text-gray-700">Território ${t.id}</label>
                            <input type="url" id="link-t${t.id}" data-id="${t.id}" value="${link}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>`;
                    container.innerHTML += inputGroup;
                });
                if(this.ui.linkSettingsModal) this.ui.linkSettingsModal.classList.remove('hidden');
            },
            async saveLinkSettings(e) {
                e.preventDefault();
                const newLinks = {};
                const inputs = this.ui.linkSettingsForm ? this.ui.linkSettingsForm.querySelectorAll('input[type="url"]') : [];
                inputs.forEach(input => {
                    const id = input.dataset.id;
                    if (input.value) {
                        newLinks[id] = input.value.trim();
                    }
                });
                try {
                    await setDoc(doc(db, "appState", "territoryLinks"), { links: newLinks });
                    console.log("Links salvos com sucesso!");
                    if(this.ui.linkSettingsModal) this.ui.linkSettingsModal.classList.add('hidden');
                    customAlert("Links atualizados com sucesso!");
                } catch (error) {
                    console.error("Erro ao salvar os links:", error);
                    customAlert("Falha ao salvar os links.");
                }
            },
            closeAllModals() { 
                if(this.ui.statusModal) this.ui.statusModal.classList.add('hidden'); 
                if(this.ui.selectionModal) this.ui.selectionModal.classList.add('hidden'); 
                if(this.ui.settingsModal) this.ui.settingsModal.classList.add('hidden'); 
                if(this.ui.historyModal) this.ui.historyModal.classList.add('hidden');
                if(this.ui.linkSettingsModal) this.ui.linkSettingsModal.classList.add('hidden');
            },
            setupWeekPicker() {
                const today = new Date();
                if(this.ui.weekPicker) {
                    this.ui.weekPicker.value = today.toISOString().split('T')[0];
                    const parts = this.ui.weekPicker.value.split('-').map(Number);
                    this.state.selectedDate = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
                    
                    this.ui.weekPicker.addEventListener('change', (e) => {
                        const parts = e.target.value.split('-').map(Number);
                        this.state.selectedDate = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
                        this.updateDateDisplay();
                        this.renderAssignmentCards();
                    });
                }
            },
            setupEventListeners() {
                if(this.ui.modeWeekdayBtn) this.ui.modeWeekdayBtn.addEventListener('click', () => this.setMode('weekday'));
                if(this.ui.modeWeekendBtn) this.ui.modeWeekendBtn.addEventListener('click', () => this.setMode('weekend'));
                
                // Event Listeners for Modals
                if(this.ui.openSettingsBtn) this.ui.openSettingsBtn.addEventListener('click', () => this.openSettingsModal());
                if(this.ui.closeSettingsBtn) this.ui.closeSettingsBtn.addEventListener('click', () => this.ui.settingsModal.classList.add('hidden'));
                if(this.ui.cancelSettingsBtn) this.ui.cancelSettingsBtn.addEventListener('click', () => this.ui.settingsModal.classList.add('hidden'));
                if(this.ui.settingsForm) this.ui.settingsForm.addEventListener('submit', (e) => this.saveSettings(e));
                
                if(this.ui.openLinkSettingsBtn) this.ui.openLinkSettingsBtn.addEventListener('click', () => this.openLinkSettingsModal());
                if(this.ui.closeLinkSettingsBtn) this.ui.closeLinkSettingsBtn.addEventListener('click', () => this.ui.linkSettingsModal.classList.add('hidden'));
                if(this.ui.cancelLinkSettingsBtn) this.ui.cancelLinkSettingsBtn.addEventListener('click', () => this.ui.linkSettingsModal.classList.add('hidden'));
                if(this.ui.linkSettingsForm) this.ui.linkSettingsForm.addEventListener('submit', (e) => this.saveLinkSettings(e));

                if(this.ui.openHistoryBtn) this.ui.openHistoryBtn.addEventListener('click', () => this.openHistoryModal());
                if(this.ui.closeHistoryBtn) this.ui.closeHistoryBtn.addEventListener('click', () => this.ui.historyModal.classList.add('hidden'));
                
                if(this.ui.filterHistoryBtn) this.ui.filterHistoryBtn.addEventListener('click', () => this.filterAndRenderHistory());
                if(this.ui.clearHistoryFilterBtn) this.ui.clearHistoryFilterBtn.addEventListener('click', () => {
                    if(this.ui.historyStartDate) this.ui.historyStartDate.value = '';
                    if(this.ui.historyEndDate) this.ui.historyEndDate.value = '';
                    this.filterAndRenderHistory();
                });
                if(this.ui.historyContainer) this.ui.historyContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('toggle-history-message')) {
                        const targetId = e.target.dataset.target;
                        const messageEl = document.getElementById(targetId);
                        if(messageEl) {
                            const isHidden = messageEl.classList.toggle('hidden');
                            e.target.textContent = isHidden ? 'Ver Mensagem' : 'Ocultar Mensagem';
                        }
                    }
                });

                document.body.addEventListener('click', async (e) => {
                    const territoryCard = e.target.closest('.territory-card');
                    if (territoryCard) {
                        const id = parseInt(territoryCard.dataset.territoryId);
                        if (e.target.closest('[data-action="open-status"]')) {
                            this.openStatusModal(id);
                        }
                        else if (e.target.classList.contains('archive-btn')) { 
                            const isPersonal = this.state.personalAssignments[id];
                            
                            // Adicionada confirmação de arquivamento
                            mainNav.showConfirmationModal(
                                'Arquivar e Registrar',
                                'Tem certeza que deseja arquivar este território? Se houver uma designação S-13 pendente, ela será registrada agora.',
                                async () => {
                                    if (isPersonal) {
                                        // É pessoal, apenas arquiva sem S-13
                                        if (!this.state.archived.includes(id)) {
                                            this.state.archived.push(id);
                                        }
                                        await this.saveState(); 
                                        console.log(`Território pessoal ${id} arquivado.`);
                                    } else {
                                        // Lógica original: dispara S-13
                                        const success = await this.triggerS13Update(id);
                                        if (success) {
                                            if (!this.state.archived.includes(id)) {
                                                this.state.archived.push(id);
                                            }
                                            await this.saveState(); 
                                        }
                                    }
                                }
                            );
                        }
                        else if (e.target.classList.contains('restore-btn')) { 
                            this.state.archived = this.state.archived.filter(i => i !== id); 
                            await this.saveState(); 
                        }
                    }
                    if (e.target.classList.contains('add-territory-btn')) this.openSelectionModal(e.target.dataset.key);
                    if (e.target.parentElement?.classList.contains('selection-badge')) {
                        const { key, id } = e.target.dataset;
                        const idValue = isNaN(parseInt(id)) ? id : parseInt(id);
                        if (this.state.mode === 'weekday') this.state.weekdaySelections[key] = this.state.weekdaySelections[key].filter(i => i != idValue);
                        else if (key === 'DOMINGO') this.state.weekendSelections[key].territories = this.state.weekendSelections[key].territories.filter(i => i != idValue);
                        else this.state.weekendSelections[key] = this.state.weekendSelections[key].filter(i => i != idValue);
                        await this.saveState();
                    }
                });

                if(this.ui.settingsModal) {
                    this.ui.settingsModal.addEventListener('click', (e) => {
                        if (e.target.id === 'add-territory-btn') {
                            const idInput = document.getElementById('new-territory-id');
                            const blocksInput = document.getElementById('new-territory-blocks');
                            if(!idInput || !blocksInput) return;
                            const id = parseInt(idInput.value);
                            const blocks = blocksInput.value.split(',').map(b => b.trim().toUpperCase()).filter(b => b);

                            if (!id || blocks.length === 0) {
                                customAlert("Por favor, preencha o número do território e as quadras.");
                                return;
                            }
                            if (this.data.some(t => t.id === id)) {
                                customAlert(`O território ${id} já existe.`);
                                return;
                            }

                            this.data.push({ id, blocks });
                            this.data.sort((a, b) => a.id - b.id);
                            this.saveTerritories(); // Isso aciona o snapshot e re-renderiza a UI
                            idInput.value = '';
                            blocksInput.value = '';
                        }

                        if (e.target.classList.contains('delete-territory-btn')) {
                            const id = parseInt(e.target.closest('.delete-territory-btn').dataset.id);
                            mainNav.showConfirmationModal(
                                'Remover Território',
                                `Tem certeza que deseja remover o território ${id}? Esta ação não pode ser desfeita.`,
                                () => {
                                    this.data = this.data.filter(t => t.id !== id);
                                    // NOVO: Também remove de designações pessoais se existir
                                    if (this.state.personalAssignments[id]) {
                                        delete this.state.personalAssignments[id];
                                        this.saveState(); // Salva a remoção do personalAssignments
                                    }
                                    this.saveTerritories(); // Salva a lista de territórios atualizada
                                }
                            );
                        }
                    });
                }

                document.body.addEventListener('input', (e) => { if (e.target.id === 'sunday-name-select') { this.state.weekendSelections.DOMINGO.name = e.target.value; this.saveState(); } });
                
                if(this.ui.toggleArchivedBtn) {
                    this.ui.toggleArchivedBtn.addEventListener('click', () => {
                        this.state.showArchived = !this.state.showArchived;
                        this.ui.toggleArchivedBtn.textContent = this.state.showArchived ? 'Mostrar Ativos' : 'Mostrar Arquivados';
                        this.ui.gridTitle.textContent = this.state.showArchived ? 'Territórios Arquivados' : 'Territórios Ativos';
                        this.renderGrid();
                    });
                }

                // Listener de EVENTOS para o modal de STATUS (Quadras + Pessoal)
                if(this.ui.statusModal) {
                    this.ui.statusModal.addEventListener('click', async (e) => {
                        const id = parseInt(this.ui.statusModal.dataset.currentTerritoryId);
                        if (!id) return;

                        // Botão Salvar Designação Pessoal
                        if (e.target.id === 'save-personal-btn') {
                            const select = this.ui.statusModal.querySelector('#personal-assignment-select');
                            const name = select ? select.value : null;
                            if (name) {
                                this.state.personalAssignments[id] = name;
                                await this.saveState();
                                customAlert(`Território ${id} salvo para ${name}.`);
                                this.closeAllModals();
                            } else {
                                customAlert("Por favor, selecione um nome para salvar.");
                            }
                        }

                        // Botão Remover Designação Pessoal
                        if (e.target.id === 'remove-personal-btn') {
                            if (this.state.personalAssignments[id]) {
                                delete this.state.personalAssignments[id];
                                await this.saveState();
                                customAlert(`Designação pessoal removida do Território ${id}.`);
                                this.closeAllModals();
                            } else {
                                customAlert("Este território não possui designação pessoal.");
                            }
                        }

                        // Botão Fechar (Salvar Status)
                        if (e.target.id === 'save-status-btn') {
                            this.closeAllModals();
                            this.renderGrid(); // Re-renderiza a grade para mostrar o status atualizado
                        }
                    });
                    
                    // Listener de MUDANÇAS para as checkboxes no modal de status
                    this.ui.statusModal.addEventListener('change', (e) => {
                        const id = parseInt(this.ui.statusModal.dataset.currentTerritoryId);
                        if (!id) return;

                        if (e.target.classList.contains('block-checkbox') || e.target.id === 'select-all-blocks') {
                            if (!this.state.status[id]) this.state.status[id] = {};
                            const cbs = this.ui.statusModal.querySelectorAll('.block-checkbox');
                            if (e.target.id === 'select-all-blocks') { cbs.forEach(cb => { cb.checked = e.target.checked; this.state.status[id][cb.dataset.block] = e.target.checked; }); }
                            else { this.state.status[id][e.target.dataset.block] = e.target.checked; this.ui.statusModal.querySelector('#select-all-blocks').checked = Array.from(cbs).every(cb => cb.checked); }
                            this.saveState();
                        }
                    });
                }

                if(this.ui.selectionModal) {
                    const confirmBtn = this.ui.selectionModal.querySelector('#confirm-selection-btn');
                    if(confirmBtn) {
                        confirmBtn.addEventListener('click', () => {
                            const key = this.ui.selectionModal.dataset.currentKey;
                            const ids = Array.from(this.ui.selectionModal.querySelectorAll('input:checked')).map(cb => isNaN(parseInt(cb.value)) ? cb.value : parseInt(cb.value));
                            if (this.state.mode === 'weekday') this.state.weekdaySelections[key] = ids;
                            else if (key === 'DOMINGO') this.state.weekendSelections[key].territories = ids;
                            else this.state.weekendSelections[key] = ids;
                            this.saveState(); this.closeAllModals();
                        });
                    }
                }
                if(this.ui.generateMessageBtn) this.ui.generateMessageBtn.addEventListener('click', () => this.generateMessage());
                if(this.ui.copyMessageBtn) {
                    this.ui.copyMessageBtn.addEventListener('click', () => {
                        if(this.ui.whatsappMessage) {
                            this.ui.whatsappMessage.select(); document.execCommand('copy');
                            if(this.ui.copySuccess) {
                                this.ui.copySuccess.classList.remove('hidden'); 
                                setTimeout(() => this.ui.copySuccess.classList.add('hidden'), 2000);
                            }
                        }
                    });
                }
                [this.ui.statusModal, this.ui.selectionModal, this.ui.settingsModal, this.ui.historyModal, this.ui.linkSettingsModal].forEach(m => {
                    if(m) {
                        m.addEventListener('click', (e) => { if (e.target === m) this.closeAllModals(); });
                        const closeBtn = m.querySelector('[id^="close-"]');
                        if(closeBtn) closeBtn.addEventListener('click', () => this.closeAllModals());
                    }
                });
                
                if(this.ui.resetArchivedBtn) {
                    this.ui.resetArchivedBtn.addEventListener('click', () => mainNav.showConfirmationModal(
                        'Zerar/Restaurar Arquivados', 
                        'Tem certeza que deseja zerar o progresso e restaurar TODOS os territórios arquivados? O progresso dos territórios ativos não será alterado.', 
                        () => this.resetArchivedTerritories()
                    ));
                }

                if(this.ui.resetTerritoriesBtn) {
                    this.ui.resetTerritoriesBtn.addEventListener('click', () => mainNav.showConfirmationModal('Zerar Territórios', 'Tem certeza que deseja zerar todos os territórios? Esta ação irá restaurar os arquivados e marcar todas as quadras como pendentes (exceto territórios com designação pessoal).', () => this.resetTerritories()));
                }
                
                if(this.ui.clearAssignmentsBtn) {
                    this.ui.clearAssignmentsBtn.addEventListener('click', () => {
                        const modeText = this.state.mode === 'weekday' ? 'dos dias de semana' : 'do final de semana';
                        mainNav.showConfirmationModal(
                            'Limpar Designações',
                            `Tem certeza que deseja limpar todas as designações ${modeText}?`,
                            () => this.clearAssignments()
                        );
                    });
                }
            },

            async resetArchivedTerritories() {
                const territoriesToReset = [...this.state.archived]; // Pega a lista de arquivados
                
                if (territoriesToReset.length === 0) {
                    customAlert("Não há territórios arquivados para zerar.");
                    return;
                }

                this.data.forEach(t => {
                    if (territoriesToReset.includes(t.id)) {
                        // 1. Zera o status (progresso)
                        this.state.status[t.id] = {}; 
                        t.blocks.forEach(b => { this.state.status[t.id][b] = false; });
                    }
                });

                // 2. Remove TODOS da lista de arquivados
                // (Filtra para manter apenas os que NÃO estavam na lista territoriesToReset)
                this.state.archived = this.state.archived.filter(id => !territoriesToReset.includes(id));

                await this.saveState();
                customAlert("Todos os territórios arquivados foram zerados e restaurados.");
            },

            async resetTerritories() {
                this.data.forEach(t => {
                    // SÓ zera o status se NÃO for pessoal
                    if (!this.state.personalAssignments[t.id]) { 
                        this.state.status[t.id] = {}; 
                        t.blocks.forEach(b => { this.state.status[t.id][b] = false; });
                    }
                });

                // SÓ remove de arquivados se NÃO for pessoal
                const personalAndArchived = this.state.archived.filter(id => this.state.personalAssignments[id]);
                this.state.archived = personalAndArchived; // Mantém apenas os pessoais que estavam arquivados

                this.state.assignmentLog = {};
                Object.keys(this.state.weekdaySelections).forEach(k => this.state.weekdaySelections[k] = []);
                Object.keys(this.state.weekendSelections).forEach(k => {
                    if(k === 'DOMINGO') this.state.weekendSelections[k] = { name: '', territories: [] };
                    else this.state.weekendSelections[k] = [];
                });
                await this.saveState();
            },
            async clearAssignments() {
                if (this.state.mode === 'weekday') {
                    Object.keys(this.state.weekdaySelections).forEach(k => {
                        this.state.weekdaySelections[k] = [];
                    });
                } else { // weekend
                    Object.keys(this.state.weekendSelections).forEach(k => {
                        if (k === 'DOMINGO') {
                            if (this.state.weekendSelections[k]) {
                                this.state.weekendSelections[k].territories = [];
                            } else {
                                this.state.weekendSelections[k] = { name: '', territories: [] };
                            }
                        } else {
                            this.state.weekendSelections[k] = [];
                        }
                    });
                }
                await this.saveState();
            },
            async triggerS13Update(territoryId) {
                // Esta função agora SÓ é chamada para territórios NÃO pessoais.
                const assignment = this.state.assignmentLog[territoryId];
                if (!assignment) {
                    customAlert(`Não é possível arquivar. A designação para o território ${territoryId} não foi registrada. Por favor, gere a mensagem de designação primeiro.`);
                    console.warn(`Nenhuma designação encontrada no log para o território ${territoryId}. Não é possível registrar na S13.`);
                    return false; // Indicate failure
                }
                let name = assignment.name;
                if (this.state.config.weekendGroupNames[name]) { name = this.state.config.weekendGroupNames[name]; }
                const startDate = assignment.date;
                const endDate = new Date().toISOString().split('T')[0];
                await s13App.addRecordAutomated(territoryId, name, startDate, endDate);
                delete this.state.assignmentLog[territoryId];
                return true; // Indicate success
            },
            async generateMessage() {
                this.updateDateDisplay();
                const startDate = this.getAssignmentStartDate();
                const dateText = this.ui.weekDates.textContent.split('para ')[1];

                const currentHour = new Date().getHours();
                let greeting = 'Boa noite';
                if (currentHour >= 5 && currentHour < 12) {
                    greeting = 'Bom dia';
                } else if (currentHour >= 12 && currentHour < 18) {
                    greeting = 'Boa tarde';
                }

                let message = `${greeting} irmãos, espero que todos estejam bem!\n\nSegue a programação de território referente a ${dateText}.\n\n`;
                let hasAssignments = false;
                const allDesignatedTerritories = [];

                const getTerritoryLine = (id) => {
                    if (typeof id !== 'number') return id;
                    const t = this.data.find(td => td.id == id);
                    if (!t) return `${id} (não encontrado)`;
                    const allBlocks = t.blocks; const pendingBlocks = allBlocks.filter(b => !(this.state.status[id] && this.state.status[id][b]));
                    if (pendingBlocks.length === 0) return `${id} (Completo)`;
                    if (pendingBlocks.length < allBlocks.length) return `${id} (${pendingBlocks.join(', ')})`;
                    return `${id}`;
                };

                if (this.state.mode === 'weekday') {
                    const dayOffsets = { 'SEGUNDA': 0, 'TERÇA': 1, 'QUARTA': 2, 'QUINTA': 3, 'SEXTA': 4 };
                    for (const [day, person] of Object.entries(this.state.config.weekday)) {
                        const selections = this.state.weekdaySelections[day];
                        if (selections && selections.length > 0) {
                            hasAssignments = true;
                            
                            const assignmentDate = new Date(startDate.getTime());
                            assignmentDate.setUTCDate(startDate.getUTCDate() + (dayOffsets[day] || 0));
                            const assignmentDateString = assignmentDate.toISOString().split('T')[0];

                            selections.forEach(id => {
                                // SÓ registra no log se não for pessoal
                                if (!this.state.personalAssignments[id]) {
                                    this.state.assignmentLog[id] = { name: person, date: assignmentDateString };
                                }
                                if (typeof id === 'number') allDesignatedTerritories.push(id);
                            });
                            const territoryNumbers = selections.map(getTerritoryLine).join(', ');
                            message += `${day.toUpperCase()} - @${person}\nTERRITÓRIO: ${territoryNumbers}\n\n`;
                        }
                    }
                } else {
                    const weekendStartDate = this.getAssignmentStartDate();
                    const saturdayDate = new Date(weekendStartDate.getTime());
                    const sundayDate = new Date(weekendStartDate.getTime());
                    sundayDate.setUTCDate(sundayDate.getUTCDate() + 1);

                    let saturdayAssignments = [];
                    for (const [key, title] of Object.entries(this.state.config.weekend)) {
                        if (key.startsWith('SABADO')) {
                            const selections = this.state.weekendSelections[key];
                            if (selections && selections.length > 0) {
                                hasAssignments = true;
                                selections.forEach(id => { 
                                    // SÓ registra no log se não for pessoal
                                    if (!this.state.personalAssignments[id]) {
                                        this.state.assignmentLog[id] = { name: key, date: saturdayDate.toISOString().split('T')[0] }; 
                                    }
                                    if (typeof id === 'number') allDesignatedTerritories.push(id);
                                });
                                const territoryNumbers = selections.map(getTerritoryLine).join(', ');
                                saturdayAssignments.push(`${title.toUpperCase()}\nTERRITÓRIO: ${territoryNumbers}`);
                            }
                        }
                    }
                    if (saturdayAssignments.length > 0) { message += 'SÁBADO:\n' + saturdayAssignments.join('\n\n') + '\n\n'; }
                    
                    const sundaySelections = this.state.weekendSelections.DOMINGO;
                    if (sundaySelections && sundaySelections.territories.length > 0) {
                        hasAssignments = true;
                        const sundayName = sundaySelections.name.trim();
                        const sundayDateString = sundayDate.toISOString().split('T')[0];
                        sundaySelections.territories.forEach(id => { 
                            // SÓ registra no log se não for pessoal
                            if (!this.state.personalAssignments[id]) {
                                this.state.assignmentLog[id] = { name: sundayName, date: sundayDateString }; 
                            }
                            if (typeof id === 'number') allDesignatedTerritories.push(id);
                        });
                        const territoryNumbers = sundaySelections.territories.map(getTerritoryLine).join(', ');
                        message += `DOMINGO - @${sundayName || 'Responsável'}\nTERRITÓRIO: ${territoryNumbers}\n\n`;
                    }
                }
                if (!hasAssignments) { 
                    message = "Por favor, designe pelo menos um território para gerar a mensagem."; 
                } else { 
                    message += "Por favor irmãos, não esqueçam de nos avisar aqui no grupo, quais territórios foram finalizados."; 
                    
                    const uniqueTerritories = [...new Set(allDesignatedTerritories)].sort((a, b) => a - b);
                    if (uniqueTerritories.length > 0) {
                        message += "\n\nLinks:\n";
                        uniqueTerritories.forEach(id => {
                            const link = this.territoryLinks[id];
                            if (link) {
                                message += `${id} - ${link}\n\n`;
                            }
                        });
                    }

                    this.saveState();
                    // Salva a designação no histórico
                    try {
                        await addDoc(collection(db, "assignmentHistory"), {
                            timestamp: serverTimestamp(),
                            periodText: `Designação para ${dateText}`,
                            message: message
                        });
                        console.log("Designação salva no histórico.");
                    } catch (error) {
                        console.error("Erro ao salvar no histórico:", error);
                    }
                }
                if(this.ui.whatsappMessage) this.ui.whatsappMessage.value = message;
                const encodedMessage = encodeURIComponent(message);
                if(this.ui.sendWhatsappLink) this.ui.sendWhatsappLink.href = `https://wa.me/?text=${encodedMessage}`;
                if(this.ui.messageOutputContainer) this.ui.messageOutputContainer.classList.remove('hidden');
            }
        };

        // =================================================================
        // REGISTRO DE TERRITÓRIOS S-13 - LÓGICA
        // =================================================================
        const s13App = {
            config: { numTerritories: 0, numDesignations: 4 },
            state: { publicadores: [], s13Data: {}, currentPage: 0 },
            ui: {
                form: document.getElementById('s13-registro-form'),
                territorioNumeroInput: document.getElementById('s13-territorio-numero'),
                nomeSelect: document.getElementById('s13-nome-select'),
                dataInicioInput: document.getElementById('s13-data-inicio'),
                dataConclusaoInput: document.getElementById('s13-data-conclusao'),
                planilhaCorpo: document.getElementById('s13-planilha-corpo'),
                baixarBtn: document.getElementById('s13-baixar-pdf'),
                openModalBtn: document.getElementById('open-names-modal-btn'),
                namesModal: document.getElementById('s13-names-modal'),
                closeModalBtn: document.getElementById('s13-close-modal-btn'),
                addNameForm: document.getElementById('s13-add-name-form'),
                novoNomeInput: document.getElementById('s13-novo-nome-input'),
                listaPublicadores: document.getElementById('s13-lista-publicadores'),
                addRecordModal: document.getElementById('s13-add-record-modal'),
                openAddRecordModalBtn: document.getElementById('open-add-record-modal-btn'),
                closeAddRecordModalBtn: document.getElementById('s13-close-add-record-modal-btn'),
                resetBtn: document.getElementById('s13-reset-btn'),
                paginationControls: document.getElementById('s13-pagination-controls')
            },

            initialize() {
                this.listenForRealtimeUpdates();
                this.setupEventListeners();
            },
            
            listenForRealtimeUpdates() {
                onSnapshot(doc(db, "appState", "s13Data"), (docSnapshot) => {
                    console.log("Recebida atualização do 's13Data'");
                    const s13Data = docSnapshot.exists() ? docSnapshot.data() : {};
                    this.state.s13Data = s13Data.data || {};
                    this.renderTable(this.state.currentPage);
                });

                onSnapshot(doc(db, "appState", "publishers"), (docSnapshot) => {
                    console.log("Recebida atualização dos 'publishers'");
                    const publishers = docSnapshot.exists() ? docSnapshot.data() : {};
                    this.state.publicadores = publishers.names || [];
                    this.renderNames();
                    window.dispatchEvent(new Event('publicadoresAtualizados'));
                });
            },

            async saveState() {
                try {
                    // Note: saveState is now only for publishers, as s13Data is managed by transactions.
                    await setDoc(doc(db, "appState", "publishers"), { names: this.state.publicadores }, { merge: true });
                    console.log("Dados de publicadores do S-13 salvos no Firestore!");
                } catch(error) {
                    console.error("Erro ao salvar dados do S-13:", error);
                }
            },
            renderNames() {
                if(!this.ui.nomeSelect || !this.ui.listaPublicadores) return;
                this.ui.nomeSelect.innerHTML = '<option value="">Selecione um nome</option>';
                this.ui.listaPublicadores.innerHTML = '';
                this.state.publicadores.forEach((nome, index) => {
                    const option = document.createElement('option'); option.value = nome; option.textContent = nome;
                    this.ui.nomeSelect.appendChild(option);
                    const li = document.createElement('li'); li.textContent = nome;
                    const deleteBtn = document.createElement('button'); deleteBtn.textContent = 'X'; deleteBtn.className = 's13-delete-btn';
                    deleteBtn.title = 'Remover nome'; deleteBtn.dataset.index = index;
                    li.appendChild(deleteBtn); this.ui.listaPublicadores.appendChild(li);
                });
            },
            addName(e) {
                e.preventDefault();
                const novoNome = this.ui.novoNomeInput ? this.ui.novoNomeInput.value.trim() : '';
                if (novoNome && !this.state.publicadores.includes(novoNome)) {
                    this.state.publicadores.push(novoNome); this.state.publicadores.sort();
                    this.saveState(); if(this.ui.novoNomeInput) this.ui.novoNomeInput.value = '';
                } else if (this.state.publicadores.includes(novoNome)) { customAlert('Este nome já está cadastrado.'); }
            },
            deleteName(e) {
                if (e.target.classList.contains('s13-delete-btn')) {
                    const index = parseInt(e.target.dataset.index, 10);
                    const nomeRemovido = this.state.publicadores[index];
                    mainNav.showConfirmationModal('Remover Nome', `Tem certeza que deseja remover "${nomeRemovido}"?`, () => {
                        this.state.publicadores.splice(index, 1);
                        this.saveState();
                    });
                }
            },
            getMaxPages() {
                let maxPages = 1;
                for (const territoryId in this.state.s13Data) {
                    const numRecords = this.state.s13Data[territoryId].length;
                    const pagesForTerritory = Math.ceil(numRecords / this.config.numDesignations) || 1;
                    if (pagesForTerritory > maxPages) {
                        maxPages = pagesForTerritory;
                    }
                }
                return maxPages;
            },
            renderPagination() {
                const maxPages = this.getMaxPages();
                if(this.ui.paginationControls) {
                    this.ui.paginationControls.innerHTML = '';
                    if (maxPages <= 1) return;
                    this.ui.paginationControls.innerHTML = `
                        <button id="s13-prev-page" class="px-3 py-1 bg-gray-200 rounded-md disabled:opacity-50" ${this.state.currentPage === 0 ? 'disabled' : ''}>Anterior</button>
                        <span class="font-semibold">Página ${this.state.currentPage + 1} de ${maxPages}</span>
                        <button id="s13-next-page" class="px-3 py-1 bg-gray-200 rounded-md disabled:opacity-50" ${this.state.currentPage >= maxPages - 1 ? 'disabled' : ''}>Próxima</button>
                    `;
                }
            },
            renderTable(pageIndex = 0) {
                this.state.currentPage = pageIndex;
                let html = '';
                for (let i = 1; i <= this.config.numTerritories; i++) {
                    const rowClass = i % 2 === 0 ? 'row-even' : 'row-odd';
                    const allRecords = this.state.s13Data[i] || [];
                    
                    const startIndex = pageIndex * this.config.numDesignations;
                    const endIndex = startIndex + this.config.numDesignations;
                    const pageData = allRecords.slice(startIndex, endIndex);

                    html += `<tr id="s13-row-${i}-names" class="${rowClass}"><td rowspan="2">${i}</td><td rowspan="2" id="s13-t${i}-last-date"></td>`;
                    for (let j = 0; j < this.config.numDesignations; j++) {
                        const record = pageData[j];
                        html += `<td colspan="2" id="s13-t${i}-name-${j}" class="name-cell">${record ? record.name : ''}</td>`;
                    }
                    html += `</tr><tr id="s13-row-${i}-dates" class="${rowClass}">`;
                    for (let j = 0; j < this.config.numDesignations; j++) {
                         const record = pageData[j];
                        html += `<td id="s13-t${i}-start-${j}">${record ? this.formatDate(record.start) : ''}</td><td id="s13-t${i}-end-${j}">${record ? this.formatDate(record.end) : ''}</td>`;
                    }
                    html += `</tr>`;
                    
                    const lastRecord = allRecords.length > 0 ? allRecords[allRecords.length - 1] : null;
                    if(lastRecord) {
                       setTimeout(() => {
                            const lastDateCell = document.getElementById(`s13-t${i}-last-date`);
                            if(lastDateCell) lastDateCell.innerHTML = this.formatDate(lastRecord.end);
                       }, 0);
                    }
                }
                if(this.ui.planilhaCorpo) this.ui.planilhaCorpo.innerHTML = html;
                this.renderPagination();
            },
            formatDate(dataStr) { if (!dataStr) return ''; const [y, m, d] = dataStr.split('T')[0].split('-'); return `${d}/${m}/${y.slice(-2)}`; },
            
            async _addRecord(territoryId, name, start, end) {
                console.log(`Tentando adicionar registro S13 para Território: ${territoryId}, Nome: ${name}, Início: ${start}, Fim: ${end}`);
                if (!territoryId || !name || !start || !end) {
                    console.error("Dados inválidos para _addRecord. Abortando.");
                    customAlert("Erro: Dados inválidos fornecidos para criar o registro.");
                    return;
                }

                const s13Ref = doc(db, "appState", "s13Data");
                try {
                    await runTransaction(db, async (transaction) => {
                        const s13Doc = await transaction.get(s13Ref);
                        const newRecord = { name, start, end };

                        const data = s13Doc.exists() ? s13Doc.data().data || {} : {};
                        
                        const newData = { ...data };

                        const records = newData[territoryId] ? [...newData[territoryId]] : [];
                        
                        records.push(newRecord);

                        newData[territoryId] = records;
                        
                        transaction.set(s13Ref, { data: newData });
                    });
                    console.log("Registro S13 salvo com sucesso via transação.");
                } catch (e) {
                    console.error("Falha na transação S13: ", e);
                    customAlert("Ocorreu um erro ao salvar o registro S13. Tente novamente.");
                }
            },

            async addRecordAutomated(territoryId, name, start, end) { 
                await this._addRecord(territoryId, name, start, end); 
            },
            async addRecordFromModal(e) {
                e.preventDefault();
                const num = this.ui.territorioNumeroInput.value; const nome = this.ui.nomeSelect.value;
                const start = this.ui.dataInicioInput.value; const end = this.ui.dataConclusaoInput.value;
                if (!num || !nome || !start || !end) { customAlert('Por favor, preencha todos os campos.'); return; }
                if (new Date(end) < new Date(start)) { customAlert('A data de conclusão não pode ser anterior à de designação.'); return; }
                await this._addRecord(num, nome, start, end);
                this.ui.form.reset(); this.ui.addRecordModal.classList.add('hidden');
            },
            async exportToPDF() {
                const element = document.createElement('div');
                element.style.width = '100%';
                // Estilos para o PDF (para garantir que bordas apareçam)
                const style = document.createElement('style');
                style.innerHTML = `
                    .pdf-page { margin-bottom: 20px; page-break-after: always; padding: 20px; }
                    .pdf-page:last-child { page-break-after: avoid; }
                    .pdf-table { width: 100%; border-collapse: collapse; font-family: 'Inter', sans-serif; font-size: 10px; }
                    .pdf-table th, .pdf-table td { border: 1px solid #000; padding: 4px; text-align: center; }
                    .pdf-table th { background-color: #f3f4f6; font-weight: bold; }
                    .pdf-header { text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #374151; }
                    .pdf-sub { text-align: center; font-size: 12px; margin-bottom: 15px; color: #4b5563; }
                `;
                element.appendChild(style);

                const maxPages = this.getMaxPages();
                
                for (let page = 0; page < maxPages; page++) {
                    const pageContainer = document.createElement('div');
                    pageContainer.className = 'pdf-page';
                    
                    const header = `<div class="pdf-header">Registro de Território S-13</div><div class="pdf-sub">Ano de Serviço 2025 - Página ${page + 1}</div>`;
                    
                    let tableHTML = `
                    <table class="pdf-table">
                        <thead>
                            <tr>
                                <th rowspan="2" style="width: 40px;">Terr. n.º</th><th rowspan="2" style="width: 60px;">Última data concluída</th>
                                <th colspan="2">Designado para</th><th colspan="2">Designado para</th>
                                <th colspan="2">Designado para</th><th colspan="2">Designado para</th>
                            </tr>
                            <tr>
                                <th>Data da desig.</th><th>Data da conclusão</th><th>Data da desig.</th><th>Data da conclusão</th>
                                <th>Data da desig.</th><th>Data da conclusão</th><th>Data da desig.</th><th>Data da conclusão</th>
                            </tr>
                        </thead>
                        <tbody>`;

                    for (let i = 1; i <= this.config.numTerritories; i++) {
                        const allRecords = this.state.s13Data[i] || [];
                        const startIndex = page * this.config.numDesignations;
                        const pageData = allRecords.slice(startIndex, startIndex + this.config.numDesignations);
                        
                        const lastRecord = allRecords.length > 0 ? allRecords[allRecords.length - 1] : null;
                        const lastDate = lastRecord ? this.formatDate(lastRecord.end) : '';

                        // Row 1: Names
                        tableHTML += `<tr><td rowspan="2">${i}</td><td rowspan="2">${lastDate}</td>`;
                        for (let j = 0; j < this.config.numDesignations; j++) {
                            const record = pageData[j];
                            tableHTML += `<td colspan="2" style="font-weight: 500;">${record ? record.name : ''}</td>`;
                        }
                        tableHTML += `</tr>`;

                        // Row 2: Dates
                        tableHTML += `<tr>`;
                        for (let j = 0; j < this.config.numDesignations; j++) {
                            const record = pageData[j];
                            tableHTML += `<td>${record ? this.formatDate(record.start) : ''}</td><td>${record ? this.formatDate(record.end) : ''}</td>`;
                        }
                        tableHTML += `</tr>`;
                    }

                    tableHTML += `</tbody></table>`;
                    pageContainer.innerHTML = header + tableHTML;
                    element.appendChild(pageContainer);
                }

                const opt = {
                    margin: 10,
                    filename: 'registro_s13.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
                };

                html2pdf().set(opt).from(element).save();
            },
            async resetS13Data() {
                // Para zerar, usamos set para sobrescrever o documento com um objeto vazio.
                await setDoc(doc(db, "appState", "s13Data"), { data: {} });
            },
            setupEventListeners() {
                if(this.ui.form) this.ui.form.addEventListener('submit', (e) => this.addRecordFromModal(e));
                if(this.ui.addNameForm) this.ui.addNameForm.addEventListener('submit', (e) => this.addName(e));
                if(this.ui.listaPublicadores) this.ui.listaPublicadores.addEventListener('click', (e) => this.deleteName(e));
                if(this.ui.baixarBtn) this.ui.baixarBtn.addEventListener('click', () => this.exportToPDF());
                if(this.ui.openModalBtn) this.ui.openModalBtn.addEventListener('click', () => this.ui.namesModal.classList.remove('hidden'));
                if(this.ui.closeModalBtn) this.ui.closeModalBtn.addEventListener('click', () => this.ui.namesModal.classList.add('hidden'));
                if(this.ui.namesModal) this.ui.namesModal.addEventListener('click', (e) => { if (e.target === this.ui.namesModal) this.ui.namesModal.classList.add('hidden'); });
                if(this.ui.openAddRecordModalBtn) this.ui.openAddRecordModalBtn.addEventListener('click', () => this.ui.addRecordModal.classList.remove('hidden'));
                if(this.ui.closeAddRecordModalBtn) this.ui.closeAddRecordModalBtn.addEventListener('click', () => this.ui.addRecordModal.classList.add('hidden'));
                if(this.ui.addRecordModal) this.ui.addRecordModal.addEventListener('click', (e) => { if (e.target === this.ui.addRecordModal) this.ui.addRecordModal.classList.add('hidden'); });
                if(this.ui.resetBtn) this.ui.resetBtn.addEventListener('click', () => mainNav.showConfirmationModal('Zerar Planilha S-13', 'Tem certeza que deseja apagar todos os dados da planilha S-13? Esta ação não pode ser desfeita.', () => this.resetS13Data()));
                if(this.ui.paginationControls) {
                    this.ui.paginationControls.addEventListener('click', (e) => {
                        if (e.target.id === 's13-prev-page') this.renderTable(this.state.currentPage - 1);
                        else if (e.target.id === 's13-next-page') this.renderTable(this.state.currentPage + 1);
                    });
                }
            }
        };

        // =================================================================
        // NAVEGAÇÃO PRINCIPAL E MODAL DE CONFIRMAÇÃO
        // =================================================================
        const mainNav = {
            navButton: document.getElementById('nav-button'),
            navTitle: document.getElementById('nav-title'),
            mainView: document.getElementById('territory-manager-view'),
            s13View: document.getElementById('s13-view'),
            confirmationModal: document.getElementById('confirmation-modal'),
            confirmBtn: document.getElementById('confirm-action-btn'),
            cancelBtn: document.getElementById('cancel-action-btn'),
            currentView: 'main',
            onConfirmCallback: null,
            initialize() {
                this.setupEventListeners();
                window.addEventListener('publicadoresAtualizados', () => {
                    territoryManager.renderAssignmentCards();
                    // NOVO: Atualiza o select de pessoal se o modal de status estiver aberto
                    const statusModal = document.getElementById('status-modal');
                    if (statusModal && !statusModal.classList.contains('hidden')) {
                        const id = parseInt(statusModal.dataset.currentTerritoryId);
                        if(id) territoryManager.openStatusModal(id);
                    }
                });
            },
            showView(viewName) {
                if (viewName === 's13') {
                    if(this.mainView) this.mainView.classList.add('hidden');
                    if(this.s13View) this.s13View.classList.remove('hidden');
                    if(this.navButton) this.navButton.textContent = 'Voltar ao Painel';
                    if(this.navTitle) this.navTitle.textContent = 'Registro S-13';
                    this.currentView = 's13';
                    s13App.renderTable(s13App.state.currentPage);
                } else {
                    if(this.s13View) this.s13View.classList.add('hidden');
                    if(this.mainView) this.mainView.classList.remove('hidden');
                    if(this.navButton) this.navButton.textContent = 'S-13';
                    if(this.navTitle) this.navTitle.textContent = 'Painel Principal';
                    this.currentView = 'main';
                }
            },
            showConfirmationModal(title, message, onConfirm) {
                if(!this.confirmationModal) return;
                const t = this.confirmationModal.querySelector('#confirmation-title');
                const m = this.confirmationModal.querySelector('#confirmation-message');
                if(t) t.textContent = title;
                if(m) m.textContent = message;
                this.onConfirmCallback = onConfirm;
                this.confirmationModal.classList.remove('hidden');
            },
            setupEventListeners() {
                if(this.navButton) {
                    this.navButton.addEventListener('click', () => {
                        this.showView(this.currentView === 'main' ? 's13' : 'main');
                    });
                }
                if(this.cancelBtn) this.cancelBtn.addEventListener('click', () => this.confirmationModal.classList.add('hidden'));
                if(this.confirmBtn) {
                    this.confirmBtn.addEventListener('click', () => {
                        if (this.onConfirmCallback) this.onConfirmCallback();
                        this.confirmationModal.classList.add('hidden');
                    });
                }
            }
        };

        // INICIALIZAÇÃO DE TODAS AS PARTES DA APLICAÇÃO
        territoryManager.initialize();
        s13App.initialize();
        mainNav.initialize();
    });
    </script>

    <!-- SCRIPT PWA (SERVICE WORKER) -->
    <script>
        // Registra o Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw1.js')
                    .then(registration => {
                        console.log('ServiceWorker registrado com sucesso: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('Falha ao registrar ServiceWorker: ', error);
                    });
            });
        }
    </script>

</body>
</html>
