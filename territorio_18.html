<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão do Território</title>
    <link rel="icon" href="favicon.png" onerror="this.href='favicon.jpg'">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        #app-container { padding-bottom: 120px; /* Space for the legend */ }
        .house-box {
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .house-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .notification {
            transition: opacity 0.5s, transform 0.5s;
            transform: translateX(100%);
            opacity: 0;
        }
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        .legend {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-4 right-4 z-[100] space-y-2"></div>

    <!-- Container da Aplicação -->
    <div id="app-container" class="container mx-auto max-w-lg"></div>
    
    <!-- Legenda Fixa -->
    <div id="legend-container" class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 shadow-lg z-40 hidden">
         <div class="container mx-auto max-w-lg">
            <div class="grid gap-x-6 gap-y-2 legend">
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-blue-600 mr-2"></span><span>Casa Feita</span></div>
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-red-500 mr-2"></span><span>Não Bater</span></div>
                <div class="flex items-center"><span class="font-bold w-4 text-center mr-2">F</span><span>Fundo</span></div>
                <div class="flex items-center"><span class="font-bold w-4 text-center mr-2">T</span><span>Terreno</span></div>
                <div class="flex items-center"><span class="font-bold w-4 text-center mr-2">C</span><span>Comércio</span></div>
                <div class="flex items-center whitespace-nowrap"><span class="font-bold w-auto text-center mr-2">JW</span><span>T. de Jeová</span></div>
            </div>
        </div>
    </div>

    <!-- Modal de Imagem do Mapa -->
    <div id="map-image-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="relative bg-white p-2 rounded-lg shadow-xl">
            <button id="close-map-modal-btn" class="absolute -top-4 -right-4 text-white bg-gray-800 rounded-full h-10 w-10 flex items-center justify-center text-2xl z-10">&times;</button>
            <img id="modal-map-image" src="" alt="Mapa do Território" class="max-w-full max-h-[85vh] rounded">
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
            <h2 class="text-xl font-bold mb-4">Confirmar Ação</h2>
            <p id="confirmation-modal-text" class="text-gray-600 mb-6">Você tem certeza?</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-action-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="confirm-action-btn" class="bg-blue-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-600">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Informação -->
    <div id="info-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
            <h2 class="text-xl font-bold mb-4">Informação</h2>
            <p class="text-gray-600 mb-6">Se algum número de casa estiver errado ou faltando, por favor, procure por Guilherme e mande os números corretos para atualizar pelo WhatsApp. Obrigado!</p>
            <div class="flex justify-center">
                <button id="close-info-modal-btn" class="bg-blue-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-600">Entendi</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const TERRITORY_ID = "18";

        const firebaseConfig = {
            apiKey: "AIzaSyCFHsGwsoiVRhV0LblPKvY6gsws3bfbwXY",
            authDomain: "quadrascasas.firebaseapp.com",
            projectId: "quadrascasas",
            storageBucket: "quadrascasas.firebasestorage.app",
            messagingSenderId: "1088979227180",
            appId: "1:1088979227180:web:fbf72a87b811236efeb789",
            measurementId: "G-YEQ216076G"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await signInAnonymously(auth);
            } catch(error) {
                document.getElementById('app-container').innerHTML = `<p class="text-red-500 text-center p-4">Erro de autenticação.</p>`;
                console.error("Authentication failed:", error);
                return;
            }

            const appContainer = document.getElementById('app-container');
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmActionBtn = document.getElementById('confirm-action-btn');
            const cancelActionBtn = document.getElementById('cancel-action-btn');
            const confirmationModalText = document.getElementById('confirmation-modal-text');
            const legendContainer = document.getElementById('legend-container');
            
            const mapImageModal = document.getElementById('map-image-modal');
            const modalMapImage = document.getElementById('modal-map-image');
            const closeMapModalBtn = document.getElementById('close-map-modal-btn');
            
            const notificationContainer = document.getElementById('notification-container');
            
            const infoModal = document.getElementById('info-modal');
            const closeInfoModalBtn = document.getElementById('close-info-modal-btn');

            const territoryDocRef = doc(db, "territories", TERRITORY_ID);
            let currentTerritoryData = {};

            onSnapshot(territoryDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentTerritoryData = docSnap.data();
                    handleRouteChange();
                } else {
                    appContainer.innerHTML = `<p class="text-center p-4">Território ${TERRITORY_ID} não encontrado.</p>`;
                }
            });
            
            function showNotification(message, type = 'success') {
                const notif = document.createElement('div');
                let bgColor = 'bg-green-500';
                if (type === 'error') bgColor = 'bg-red-500';
                if (type === 'info') bgColor = 'bg-yellow-500';

                notif.className = `notification ${bgColor} text-white py-2 px-4 rounded-lg shadow-md`;
                notif.textContent = message;
                
                notificationContainer.appendChild(notif);
                setTimeout(() => { notif.classList.add('show'); }, 10);
                setTimeout(() => {
                    notif.classList.remove('show');
                    notif.addEventListener('transitionend', () => notif.remove());
                }, 3000);
            }

            function handleRouteChange() {
                const hash = window.location.hash.substring(1);
                const [blockName, streetName] = hash.split('&').map(decodeURIComponent);

                if (blockName && streetName) {
                    legendContainer.classList.remove('hidden');
                    renderStreetView(blockName, streetName, currentTerritoryData);
                } else {
                    legendContainer.classList.add('hidden');
                    if (blockName) {
                        renderBlockView(blockName, currentTerritoryData);
                    } else {
                        renderListView(currentTerritoryData);
                    }
                }
            }

            function renderListView(data) {
                const territoryName = data.name || `Território ${TERRITORY_ID}`;
                document.title = `Gestão: ${territoryName}`;
                let blocksHtml = data.blocks?.map(block => `
                     <a href="#${encodeURIComponent(block.name)}" class="block-link flex items-center bg-white p-4 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex-1"><h3 class="font-bold text-xl">Quadra ${block.name}</h3></div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </a>`).join('') || '<p class="text-gray-500 text-center col-span-full">Nenhuma quadra adicionada.</p>';
                
                appContainer.innerHTML = `
                    <div class="p-4">
                         <div class="bg-blue-100 text-blue-800 p-6 rounded-2xl mb-6 flex justify-between items-start shadow-sm">
                            <div>
                                <h1 class="text-2xl font-bold">Olá Publicador(a),</h1>
                                <p>Preencha as casas da quadra onde você falou!</p>
                                <p class="font-bold mt-3 text-lg">${TERRITORY_ID} - ${territoryName}</p>
                            </div>
                            <svg id="territory-map-icon" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500 cursor-pointer flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" /></svg>
                        </div>
                        <div class="space-y-3">${blocksHtml}</div>
                    </div>`;
            }

            function renderBlockView(blockName, data) {
                const territoryName = data.name || `Território ${TERRITORY_ID}`;
                const block = data.blocks?.find(b => b.name === blockName);
                if (!block) { window.location.hash = ''; return; }
                document.title = `Quadra ${blockName} - ${territoryName}`;

                let streetsContentHtml;
                if (!block.streets || block.streets.length === 0) {
                    streetsContentHtml = `
                        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg shadow-md my-4 mx-4" role="alert">
                            <p class="font-bold">Aviso</p>
                            <p>Ainda não temos as ruas desta quadra cadastradas. Por favor, envie para o meu whatsapp para que eu possa adicionar e atualizar. obrigado. ass: Guilherme</p>
                        </div>
                    `;
                } else {
                    streetsContentHtml = '<div class="p-4 space-y-3">' + block.streets.map(street => {
                        const houseNumbers = street.houses.split(',').map(h => h.trim()).filter(Boolean);
                        const range = houseNumbers.length > 1 ? `${houseNumbers[0]} à ${houseNumbers[houseNumbers.length - 1]}` : (houseNumbers.length === 1 ? `Nº ${houseNumbers[0]}` : 'Nenhum número');
                        const mapLinkIcon = street.mapLink 
                            ? `<a href="${street.mapLink}" target="_blank" rel="noopener noreferrer" class="bg-gray-200 p-3 rounded-lg hover:bg-gray-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg></a>`
                            : `<div class="bg-gray-200 p-3 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg></div>`;
                        return `<div class="flex items-center bg-white p-2 rounded-xl shadow-sm gap-2">${mapLinkIcon}<a href="#${encodeURIComponent(block.name)}&${encodeURIComponent(street.name)}" class="street-link flex-grow flex justify-between items-center p-2"><div><h3 class="font-bold text-lg">${street.name}</h3><p class="text-sm text-gray-500">Nº de ${range}</p></div><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></a></div>`;
                    }).join('') + '</div>';
                }

                 appContainer.innerHTML = `
                    <div class="bg-blue-100 text-blue-800 p-6 rounded-b-3xl shadow-lg relative">
                         <a href="#" class="absolute top-0 left-0 h-full px-5 flex items-center text-blue-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></a>
                         <button id="info-btn" class="absolute top-0 right-0 h-full px-5 flex items-center text-blue-800">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                         </button>
                        <div class="text-center">
                            <h1 class="text-2xl font-bold">${TERRITORY_ID} - ${territoryName}</h1>
                            <p class="text-xl">Quadra ${block.name}</p>
                        </div>
                    </div>
                    ${streetsContentHtml}`;
            }

            function getStatusStyle(status) {
                switch (status) {
                    case 'DONE': return 'bg-blue-600 text-white';
                    case 'DND': return 'bg-red-500 text-white';
                    case 'F':
                    case 'T':
                    case 'C':
                    case 'JW': return 'bg-gray-200 text-gray-800';
                    default: return 'bg-white text-gray-800';
                }
            }
            
            function renderStreetView(blockName, streetName, data) {
                const block = data.blocks?.find(b => b.name === blockName);
                const street = block?.streets?.find(s => s.name === streetName);
                if (!street) { window.location.hash = encodeURIComponent(blockName); return; }
                document.title = `${streetName} - Quadra ${blockName}`;
                
                const houseNumbers = street.houses.split(',').map(h => h.trim()).filter(Boolean);
                
                let streetContentHtml;
                if (houseNumbers.length === 0 || (houseNumbers.length === 1 && houseNumbers[0] === '0')) {
                    streetContentHtml = `
                        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg shadow-md my-4" role="alert">
                            <p class="font-bold">Aviso</p>
                            <p>Ainda não temos os numeros dessa rua, por favor envie para o meu whatsapp para que eu possa adicionar e atualizar as casas obrigado. ass: Guilherme</p>
                        </div>
                    `;
                } else {
                    const housesGridHtml = houseNumbers.map(num => {
                        const status = data.status?.[blockName]?.[streetName]?.[num] || null;
                        const styleClass = getStatusStyle(status);
                        const content = ['F', 'T', 'C', 'JW'].includes(status) ? status : num;
                        return `<div class="house-box w-full aspect-square flex items-center justify-center text-lg font-bold rounded-lg cursor-pointer ${styleClass}" data-house-number="${num}">${content}</div>`;
                    }).join('');

                    streetContentHtml = `
                        <h2 class="font-bold text-gray-500 my-4">CASAS</h2>
                        <div class="grid grid-cols-4 sm:grid-cols-5 gap-4">${housesGridHtml}</div>
                    `;
                }
                
                appContainer.innerHTML = `
                    <div class="bg-blue-100 text-blue-800 p-6 rounded-b-3xl shadow-lg relative">
                        <a href="#${encodeURIComponent(blockName)}" class="absolute top-0 left-0 h-full px-5 flex items-center text-blue-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></a>
                        <button id="info-btn" class="absolute top-0 right-0 h-full px-5 flex items-center text-blue-800">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </button>
                        <div class="text-center">
                            <h1 class="text-2xl font-bold">${TERRITORY_ID} - ${data.name}</h1>
                            <p class="text-xl">Quadra ${blockName}</p>
                            <p>${streetName}</p>
                        </div>
                    </div>
                    <div class="p-4">
                        ${streetContentHtml}
                    </div>`;
            }

            function showConfirmationModal(blockName, streetName, houseNumber) {
                const currentStatus = currentTerritoryData.status?.[blockName]?.[streetName]?.[houseNumber] || null;
                const isDone = currentStatus === 'DONE';
                confirmationModalText.textContent = isDone 
                    ? `Deseja desmarcar a casa ${houseNumber} como feita?`
                    : `Deseja marcar a casa ${houseNumber} como feita?`;
                confirmActionBtn.dataset.blockName = blockName;
                confirmActionBtn.dataset.streetName = streetName;
                confirmActionBtn.dataset.houseNumber = houseNumber;
                confirmationModal.classList.remove('hidden');
            }

            function closeConfirmationModal() {
                confirmationModal.classList.add('hidden');
            }
            
            async function setHouseStatus(blockName, streetName, houseNumber, status) {
                const path = `status.${blockName}.${streetName}.${houseNumber}`;
                const docRef = territoryDocRef;
                
                try {
                    if (status === null) {
                        await updateDoc(docRef, { [path]: deleteField() });
                    } else {
                        await updateDoc(docRef, { [path]: status });
                    }
                } catch(error) {
                     console.error("Erro ao salvar status:", error);
                     // Se o erro for por aninhamento, tenta criar o objeto pai
                    if (error.code === 'invalid-argument') {
                         await setDoc(docRef, { status: { [blockName]: { [streetName]: { [houseNumber]: status } } } }, { merge: true });
                    } else {
                        throw error;
                    }
                }
            }

            async function toggleDoneStatus(blockName, streetName, houseNumber) {
                const currentStatus = currentTerritoryData.status?.[blockName]?.[streetName]?.[houseNumber] || null;
                const newStatus = currentStatus === 'DONE' ? null : 'DONE';
                await setHouseStatus(blockName, streetName, houseNumber, newStatus);
            }

            appContainer.addEventListener('click', (e) => {
                const houseBox = e.target.closest('.house-box');
                if (houseBox) {
                    const [blockName, streetName] = window.location.hash.substring(1).split('&').map(decodeURIComponent);
                    const houseNumber = houseBox.dataset.houseNumber;
                    const currentStatus = currentTerritoryData.status?.[blockName]?.[streetName]?.[houseNumber] || null;

                    if (currentStatus === 'DND') {
                        showNotification('Esta casa não deve ser trabalhada.', 'info');
                        return;
                    }
                    showConfirmationModal(blockName, streetName, houseNumber);
                }
                if (e.target.closest('#territory-map-icon')) {
                    const baseImageName = `territorio${TERRITORY_ID}`;
                    modalMapImage.src = `${baseImageName}.jpg`; // Tenta carregar JPG primeiro
                    mapImageModal.classList.remove('hidden');
                }
                if (e.target.closest('#info-btn')) {
                    infoModal.classList.remove('hidden');
                }
            });
            
            // Lógica para tentar carregar PNG se JPG falhar
            modalMapImage.onerror = () => {
                const currentSrc = modalMapImage.src;
                // Evita loop infinito se nem JPG nem PNG existirem
                if (currentSrc.endsWith('.jpg')) {
                    modalMapImage.src = currentSrc.replace('.jpg', '.png');
                } else {
                    // Se já tentou PNG e falhou, mostra a imagem reserva
                    modalMapImage.src = 'https://placehold.co/800x600/EFEFEF/AAAAAA&text=Mapa+Nao+Encontrado';
                }
            };
            
            closeMapModalBtn.addEventListener('click', () => mapImageModal.classList.add('hidden'));
            mapImageModal.addEventListener('click', (e) => { if (e.target === mapImageModal) mapImageModal.classList.add('hidden'); });

            confirmActionBtn.addEventListener('click', () => {
                const { blockName, streetName, houseNumber } = confirmActionBtn.dataset;
                const isCurrentlyDone = currentTerritoryData.status?.[blockName]?.[streetName]?.[houseNumber] === 'DONE';
                const successMessage = isCurrentlyDone ? 'Casa desmarcada com sucesso!' : 'Casa marcada com sucesso!';
                
                closeConfirmationModal();

                toggleDoneStatus(blockName, streetName, houseNumber)
                    .then(() => {
                        showNotification(successMessage, 'success');
                    })
                    .catch(err => {
                        console.error("Erro ao salvar:", err);
                        showNotification('Erro ao salvar.', 'error');
                    });
            });

            cancelActionBtn.addEventListener('click', closeConfirmationModal);
            confirmationModal.addEventListener('click', (e) => { if (e.target === confirmationModal) closeConfirmationModal(); });
            
            closeInfoModalBtn.addEventListener('click', () => infoModal.classList.add('hidden'));
            infoModal.addEventListener('click', (e) => { if (e.target === infoModal) infoModal.classList.add('hidden'); });

            window.addEventListener('hashchange', handleRouteChange);
            handleRouteChange();
        });
    </script>

</body>
</html>

